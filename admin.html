<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/logo.webp" type="image/x-icon">
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background-color: #f4f6f8;
            color: #333;
        }

        /* Estilos de pesta√±as */
        .tabs {
            position:fixed;            
            display: flex;
            justify-content: center;
            width: 100%;
            background: #007bff;
            padding: 10px 0;
            z-index: 99999;
            
        }
        .tab {
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .tab:hover {
            background-color: #0056b3;
        }
        .tab.active {
            background-color: #004085;
        }

        .tab-content {
            display: none;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }

        /* Estilos de verificacion.html */
        .verificacion-container h2, .verificacion-container h3 {
            color: #1a73e8;
            font-weight: 500;
            margin-top: 50px;
        }
        .verificacion-container textarea {
            width: 100%;
            height: 120px;
            resize: vertical;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s;
        }
        .verificacion-container textarea:focus {
            border-color: #1a73e8;
            outline: none;
        }
        .verificacion-container button {
            padding: 12px 24px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            margin: 10px 0;
        }
        .verificacion-container button:hover {
            background-color: #1557b0;
            transform: translateY(-1px);
        }
        .verificacion-container button:active {
            transform: translateY(0);
        }
        #csvInput {
            margin-top: 10px;
            font-size: 14px;
        }
        #fileStatus {
            margin-top: 8px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
        }
        #fileStatus.success {
            background-color: #d4edda;
            color: #155724;
        }
        #fileStatus.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .verificacion-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        .verificacion-container th, .verificacion-container td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .verificacion-container th {
            background-color: #e9ecef;
            font-weight: 500;
        }
        .verificacion-container tr.highlight {
            background-color: #fff3cd;
        }
        .verificacion-container .success {
            color: #28a745;
            font-weight: 500;
        }
        .verificacion-container .error {
            color: #dc3545;
            font-weight: 500;
        }
        .verificacion-container .codigo-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .verificacion-container .codigo-item {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .verificacion-container .success .codigo-item {
            background-color: #d4edda;
        }
        .verificacion-container .error .codigo-item {
            background-color: #f8d7da;
        }

        /* --- Estilos minimalistas para Verificaci√≥n --- */
/* Base general */
.verificacion-container .categoria-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  padding: 8px 12px;
  margin: 10px 0;
  background: #fff;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* Categor√≠a con c√≥digos registrados ‚úÖ */
.verificacion-container .categoria-block.registrados .categoria-title {
  border-left: 4px solid #28a745;   /* Verde */
  background: #f6fff9;
}

/* Categor√≠a con c√≥digos NO registrados ‚ùå */
.verificacion-container .categoria-block.no-registrados .categoria-title {
  border-left: 4px solid #dc3545;   /* Rojo */
  background: #fff8f8;
}

.verificacion-container .categoria-title button,
.verificacion-container .toggle-btn {
  background: none;
  border: none;
  color: #555;
  font-size: 16px;
  cursor: pointer;
  margin: 0;
}

.verificacion-container .codigo-item {
  display: inline-block;
  padding: 6px 12px;
  margin: 4px;
  border-radius: 20px;
  font-size: 13px;
  background-color: #f1f3f4;
  color: #333;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.verificacion-container .success .codigo-item {
  background-color: #e6f4ea;
  color: #137333;
}

.verificacion-container .error .codigo-item {
  background-color: #fce8e6;
  color: #c5221f;
}

/* Bot√≥n global m√°s sutil */
.global-toggle-btn {
  background: none;
  border: none;
  color: #1a73e8;
  font-size: 14px;
  cursor: pointer;
  float: right;
  margin-bottom: 10px;
}
.codigo-list {
  list-style: none;
  margin: 0;
  padding-left: 20px;
}

.codigo-list li {
  padding: 6px 0;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

.codigo-list li:last-child {
  border-bottom: none;
}

.codigo-list.success li {
  color: #137333;
}

.codigo-list.error li {
  color: #c5221f;
}
.categoria-block {
    margin-bottom: 15px;   /* espacio entre bloques */
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fff;
    overflow: hidden;
}

.categoria-title {
    background: #f5f5f5;
    padding: 10px 12px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    position: sticky;
    top: 0;                /* hace que el t√≠tulo se quede arriba al scrollear */
    z-index: 1;
}

.categoria-content {
    max-height: 400px;     /* limitar altura de listas largas */
    overflow-y: auto;      /* scroll vertical si excede */
    padding: 5px 15px;
}











        /* Estilos de admin.html */
        .admin-container h2 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            margin-top: 50px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .admin-container .error {
            color: red;
            font-size: 14px;
            text-align: center;
        }
        #login-section {
            display: block;
        }
        #admin-section {
            display: none;
        }
        #product-list {
            margin-top: 20px;
        }
        #product-list li {
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .btn-agregar, .btn-exportar, .btn-limpiar {
            padding: 10px 20px;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-agregar {
            background: #28a745;
        }
        .btn-agregar:hover {
            background: #218838;
        }
        .btn-exportar {
            background: #007bff;
        }
        .btn-exportar:hover {
            background: #0056b3;
        }
        .btn-limpiar {
            background: #dc3545;
        }
        .btn-limpiar:hover {
            background: #c82333;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            text-align: left;
            align-items: baseline;
            gap: 5px;
            margin-top: 5px;
        }
        .checkbox-item {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        .checkbox-item label {
            font-size: 14px;
            margin: 0;
            white-space: nowrap;
        }
        .success-message {
    display: none;
    padding: 12px 24px;
    margin-top: 15px;
    border-radius: 8px;
    background: linear-gradient(135deg, #28a745, #34d058);
    color: white;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    opacity: 0;
    transform: scale(0.9);
    animation: none;
}

.success-message.active {
    display: inline-block;
    animation: popFadeIn 0.8s ease forwards, glow 1.5s ease-in-out infinite alternate;
}

@keyframes popFadeIn {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes glow {
    from {
        box-shadow: 0 0 10px rgba(52, 208, 88, 0.4);
    }
    to {
        box-shadow: 0 0 20px rgba(52, 208, 88, 0.8);
    }
}


.codigo-checkbox {
    margin: 0 5px 0 0;
    vertical-align: middle;
}
.verificacion-container table td div {
    margin-bottom: 5px;
}


        

        /* Estilos de admin-stats.html */
        .stats-container header {
            background: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 50px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-bar {
            flex: 1;
            display: flex;
            gap: 8px;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-bar button {
            background: #007bff;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 250px;
        }
        .card h3 {
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 8px;
        }
        .full-width-card {
            width: 100%;
            order: 999;
        }
        .horizontal-product-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #007bff #f8f9fa;
        }
        .horizontal-product-container::-webkit-scrollbar {
            height: 8px;
        }
        .horizontal-product-container::-webkit-scrollbar-track {
            background: #f8f9fa;
        }
        .horizontal-product-container::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }
        .product-card {
            flex: 0 0 auto;
            width: 200px;
            background: #f8f9f9;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .product-card img {
            max-width: 100%;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            .tab {
                padding: 10px;
                text-align: center;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .verificacion-container table, .verificacion-container th, .verificacion-container td {
                font-size: 12px;
                padding: 8px;
            }
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preview-image {
            max-width: 100px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .dashboard-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .chart-container {
            grid-column: 1 / -1;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        /* Estilos para el bot√≥n de colapsar/expandir */
        
.toggle-btn {
    background: white;
    border: none;
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-left: 10px;
    transition: color 0.2s;
}

.toggle-btn:hover {
    color: #ffffff;
}

/* Estilos para el t√≠tulo de la subcategor√≠a */
.categoria-title {
    font-size: 1.2em;
    margin: 10px 0;
    padding: 8px 0;
    transition: font-size 0.3s ease, margin 0.3s ease, padding 0.3s ease;
}


/* Estilos cuando la subcategor√≠a est√° colapsada */
.categoria-block.collapsed .categoria-title {
    font-size: 0.9em; /* T√≠tulo m√°s peque√±o */
    margin: 5px 0; /* Menos margen vertical */
    padding: 4px 0; /* Menos padding vertical */
}

/* Ocultar el contenido de la subcategor√≠a cuando est√° colapsada */
.categoria-block.collapsed .categoria-content {
    display: none;
}

/* Transici√≥n suave para el contenido */
.categoria-content {
    transition: max-height 0.3s ease, opacity 0.3s ease;
    max-height: 1000px; /* Ajusta seg√∫n necesidad */
    opacity: 1;
}

.categoria-block.collapsed .categoria-content {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
}

/* Estilo para el bot√≥n global */
.global-toggle-btn {
    padding: 10px 20px;
    background-color: #ffffff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    margin: 10px 0;
    transition: background-color 0.2s;
}

.global-toggle-btn:hover {
    background-color: #1557b0;
}

/* Reducir el espacio del contenedor colapsado */
.categoria-block.collapsed {
    margin-bottom: 5px; /* Menos espacio entre subcategor√≠as colapsadas */
    transition: margin-bottom 0.3s ease;
}

.categoria-block {
    margin-bottom: 15px; /* Espacio normal cuando no est√° colapsado */
    transition: margin-bottom 0.3s ease;
}

    </style>
</head>
<body>
    <!-- Pesta√±as de navegaci√≥n -->
    <div class="tabs">
        <div class="tab active" onclick="openTab('verificacion')">Verificador de C√≥digos</div>
        <div class="tab" onclick="openTab('gestion')">Gesti√≥n de Productos</div>
        <div class="tab" onclick="openTab('stats')">Estad√≠sticas</div>
    </div>

    <!-- Contenido de las pesta√±as -->
    <div id="verificacion" class="tab-content verificacion-container active">
        <h2>Verificador de C√≥digos de Productos</h2>
        <p>Ingrese los c√≥digos separados por comas o uno por l√≠nea:</p>
        <textarea id="codigosInput" placeholder="Ejemplo: 18079, 12345, 67890"></textarea>
        <br>
        <button onclick="verificarManual()">Verificar Manual</button>
        
        <h3>Cargar archivo CSV</h3>
        <input type="file" id="csvInput" onchange="procesarCSV(this.files[0])">
        <div id="fileStatus"></div>
        <button onclick="limpiarCodigosMarcados()">Limpiar C√≥digos Marcados</button>
        <div id="resultado"></div>
        <div id="verificacionResultados"></div>

    </div>

    <div id="gestion" class="tab-content admin-container">
        <div id="login-section">
            <h2>Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" placeholder="Ingresa la contrase√±a">
            </div>
            <button class="btn-exportar" onclick="login()">Ingresar</button>
            <p id="login-error" class="error"></p>
        </div>
        <div id="admin-section">
            <h2>Agregar Producto</h2>
            <form id="product-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="categoria">Categor√≠a</label>
                    <select id="categoria" required>
                        <option value="" disabled selected>Selecciona una categor√≠a</option>
                        <!-- Opciones pobladas por populateCategories() -->
                    </select>
                </div>
                <div class="form-group" id="subcategoria-group" style="display: none;">
                    <label for="subcategoria">Subcategor√≠a</label>
                    <select id="subcategoria">
                        <option value="" disabled selected>Selecciona una subcategor√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" required>
                </div>
                <div class="form-group">
                    <label for="codigo">C√≥digo</label>
                    <input type="text" id="codigo" required>
                </div>
                <div class="form-group">
                    <label for="marca">Marca</label>
                    <input type="text" id="marca">
                </div>
                <div class="form-group">
                    <label for="imagen">Imagen principal (jpg, png, webp)</label>
                    <input type="file" id="imagen" name="imagen" accept="image/jpeg,image/png,image/webp" required>
                </div>
                <div class="form-group">
                    <label for="imagenes">Im√°genes adicionales (jpg, png, webp)</label>
                    <input type="file" id="imagenes" name="imagenes" accept="image/jpeg,image/png,image/webp" multiple>
                </div>
                <div id="image-preview" class="image-preview"></div>
                <div id="dynamic-fields"></div>
                <div class="button-group"></div>
                <button type="submit" class="btn-agregar">Agregar Producto</button>
                <button class="btn-exportar" onclick="exportProducts()">Exportar productos.js</button>
                <button class="btn-limpiar" onclick="clearProducts()">Limpiar Lista</button>
                </div>
                <div id="success-message" class="success-message"></div>
            </form>
            <h3>Productos Agregados</h3>
            <ul id="product-list"></ul>
        </div>
    </div>

    <div id="stats" class="tab-content stats-container">
        <header>Panel de Administraci√≥n</header>
        <div class="controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar productos...">
                <button onclick="buscarProducto()">Buscar</button>
            </div>
        </div>
        <div id="dashboard-estadisticas" class="dashboard-container">
        <div class="card">
            <h3>Producto m√°s visto</h3>
            <p id="producto-mas-visto">Cargando...</p>
        </div>
        <div class="card">
            <h3>Total visitas</h3>
            <p id="total-visitas">Cargando...</p>
        </div>
        <div class="card">
            <h3>Dispositivos nuevos</h3>
            <p id="total-dispositivos">Cargando...</p>
        </div>
        <div class="card">
            <h3>Total compartidas</h3>
            <p id="total-compartidas">Cargando...</p>
        </div>
        <div class="chart-container">
            <canvas id="chartVisitasProductos"></canvas>
        </div>
    </div>

    </div>

    

    <canvas id="chartVisitas"></canvas>


    <script src="productos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    let productosCSV = [];

    // Cargar CSV de productos
    Papa.parse("productos.csv", {
        download: true,
        header: true,
        delimiter: ";",
        complete: function(results) {
            productosCSV = results.data.map(row => ({
                codigo: String(row["Art√≠culo"]).trim(),
                nombre: String(row["Descripci√≥n"]).trim()
            }));
            console.log("Productos CSV cargados:", productosCSV.length);
        }
    });
    </script>

    <script src="scripts.js"></script>
<script>
    // Gesti√≥n de pesta√±as
    function openTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }
    // Objeto para almacenar las posiciones de scroll de cada pesta√±a
const scrollPositions = {
    verificacion: 0,
    gestion: 0,
    stats: 0
};

// Funci√≥n para guardar la posici√≥n de scroll de la pesta√±a activa
function saveScrollPosition() {
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab) {
        const tabId = activeTab.id;
        scrollPositions[tabId] = activeTab.scrollTop;
    }
}

// Funci√≥n para restaurar la posici√≥n de scroll de una pesta√±a
function restoreScrollPosition(tabId) {
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
        tabContent.scrollTop = scrollPositions[tabId] || 0;
    }
}

// Gesti√≥n de pesta√±as
function openTab(tabName) {
    // Guardar la posici√≥n de scroll de la pesta√±a activa actual
    saveScrollPosition();

    // Desactivar todas las pesta√±as y contenidos
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // Activar la pesta√±a seleccionada
    document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');

    // Restaurar la posici√≥n de scroll de la pesta√±a activada
    restoreScrollPosition(tabName);
}

// A√±adir un manejador para actualizar la posici√≥n de scroll en tiempo real
document.querySelectorAll('.tab-content').forEach(tab => {
    tab.addEventListener('scroll', () => {
        if (tab.classList.contains('active')) {
            scrollPositions[tab.id] = tab.scrollTop;
        }
    });
});

    // C√≥digo de verificacion.html
    let csvContent = null;
    let codigoToCategoria = {};

    function verificarManual() {
        const input = document.getElementById('codigosInput').value;
        const codigos = input.split(/[\n,]+/).map(c => c.trim()).filter(c => c);
        verificarYMostrar(codigos);
    }

    

    function procesarCSV(file) {
    if (!file) {
        console.error("No se seleccion√≥ ning√∫n archivo.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const codigos = parsearCSV(text);
        if (codigos.length === 0) {
            document.getElementById('fileStatus').innerHTML = '<span class="error">No se encontraron c√≥digos v√°lidos en el archivo.</span>';
            document.getElementById('fileStatus').className = 'error';
            return;
        }
        document.getElementById('fileStatus').innerHTML = '<span class="success">Archivo cargado correctamente.</span>';
        document.getElementById('fileStatus').className = 'success';

        // üîé Mostrar los productos directamente en la pesta√±a Verificaci√≥n
        verificarYMostrar(codigos);
    };
    reader.readAsText(file, "ISO-8859-1");
}




    // -----------------------------
// Nuevas variables / utilidades
// -----------------------------
let productosCSVMap = {}; // mapa: codigoNormalizado -> nombre

function normalizeCode(c) {
    if (c === undefined || c === null) return '';
    // pasar a string, trim, quitar comillas y ceros a la izquierda
    return String(c).trim().replace(/^"+|"+$/g, '').replace(/^0+/, '');
}

function getNombrePorCodigo(codigo) {
    const codNorm = normalizeCode(codigo);
    if (!codNorm) return 'Desconocido';

    // 1) buscar en el mapa generado desde el CSV
    if (productosCSVMap && productosCSVMap[codNorm]) {
        const n = productosCSVMap[codNorm];
        return (n && n.trim()) ? n.trim() : 'Desconocido';
    }

    // 2) fallback: buscar en productos (productos.js)
    if (typeof productos !== 'undefined' && Array.isArray(productos)) {
        const prod = productos.find(p => normalizeCode(p.codigo) === codNorm);
        if (prod) {
            // varios nombres posibles seg√∫n tu productos.js
            return prod.nombre || prod.Nombre || prod.name || prod.title || prod.descripcion || prod.Descripcion || 'Desconocido';
        }
    }

    return 'Desconocido';
}

// ---------------------------------
// parsearCSV (reemplaza la anterior)
// ---------------------------------
function parsearCSV(text) {
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    if (lines.length === 0) return [];

    const headersRaw = lines[0].split(';').map(h => h.trim().replace(/^"|"$/g, ''));

    // Normalizar encabezados: quitar acentos y caracteres raros
    const normalizeHeader = h => {
        return h
            .normalize("NFD")                     // separar letras y tildes
            .replace(/[\u0300-\u036f]/g, "")      // eliminar tildes
            .replace(/[^a-zA-Z0-9 ]/g, "")        // quitar caracteres no alfanum√©ricos
            .toLowerCase()
            .trim();
    };

    const headerNorm = headersRaw.map(h => normalizeHeader(h));

    // Buscar √≠ndices de columnas con nombres normalizados
    const articuloIndex   = headerNorm.findIndex(h => h.includes('articulo'));
    const descripcionIndex = headerNorm.findIndex(h => h.includes('descrip'));
    const agrupacionIndex  = headerNorm.findIndex(h => h.includes('agrup'));

    if (articuloIndex === -1) {
        document.getElementById('fileStatus').innerHTML =
            '<span class="error">No se encontr√≥ la columna "Art√≠culo" en el CSV.</span>';
        document.getElementById('fileStatus').className = 'error';
        console.warn('parsearCSV: columna Art√≠culo no encontrada. Encabezados normalizados:', headerNorm);
        return [];
    }

    const codigos = [];
    codigoToCategoria = {};
    productosCSVMap = {};

    for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(';').map(c => c.trim().replace(/^"|"$/g, ''));
        const codigoRaw = columns[articuloIndex];
        if (codigoRaw) {
            const codigo = codigoRaw;
            codigos.push(codigo);

            const categoria = (agrupacionIndex !== -1) ? (columns[agrupacionIndex] || 'Sin categor√≠a') : 'Sin categor√≠a';
            codigoToCategoria[codigo] = categoria;

            const nombre = (descripcionIndex !== -1) ? (columns[descripcionIndex] || '') : '';
            const key = normalizeCode(codigo);
            productosCSVMap[key] = nombre ? nombre : '';
        }
    }

    console.log(`parsearCSV: codigos extra√≠dos=${codigos.length}, productosCSVMap entries=${Object.keys(productosCSVMap).length}`);
    return codigos.filter(c => c);
}


// -------------------------------------------------
// verificarCodigos: versi√≥n que normaliza al buscar
// -------------------------------------------------
function verificarCodigos(codigosIngresados) {
    const codigosUnicos = [...new Set(codigosIngresados.map(c => String(c).trim()).filter(Boolean))];
    const registradosPorCategoria = {};
    const noRegistradosPorCategoria = {};

    codigosUnicos.forEach(codigo => {
        const codigoNorm = normalizeCode(codigo);
        let producto = undefined;

        if (typeof productos !== 'undefined' && Array.isArray(productos)) {
            producto = productos.find(p => normalizeCode(p.codigo) === codigoNorm);
        }

        if (producto) {
            const categoria = producto.categoria || 'Sin categor√≠a';
            if (!registradosPorCategoria[categoria]) registradosPorCategoria[categoria] = [];
            registradosPorCategoria[categoria].push(codigo);
        } else {
            // intentar usar categoria desde el CSV (buscar por clave normalizada o sin normalizar)
            let categoria = codigoToCategoria[codigo] || codigoToCategoria[codigoNorm] || 'Sin categor√≠a';
            if (!noRegistradosPorCategoria[categoria]) noRegistradosPorCategoria[categoria] = [];
            noRegistradosPorCategoria[categoria].push(codigo);
        }
    });

    return { registradosPorCategoria, noRegistradosPorCategoria };
}

// -------------------------------------------------
// verificarYMostrar (usa getNombrePorCodigo)
// -------------------------------------------------
const codigosMarcados = JSON.parse(localStorage.getItem('codigosMarcados') || '{}');

function verificarYMostrar(codigos) {
    const container = document.getElementById("resultado"); 
    if (!container) {
        console.error("Contenedor resultado no encontrado");
        return;
    }

    const { registradosPorCategoria, noRegistradosPorCategoria } = verificarCodigos(codigos);

    // Estado de checkboxes y colapsado
    const codigosMarcados = JSON.parse(localStorage.getItem('codigosMarcados') || '{}');
    const collapsedState = JSON.parse(localStorage.getItem('collapsedCategories') || '{}');

    // Totales
    const totalRegistrados = Object.values(registradosPorCategoria).reduce((sum, arr) => sum + arr.length, 0);
    const totalNoRegistrados = Object.values(noRegistradosPorCategoria).reduce((sum, arr) => sum + arr.length, 0);

    // Auxiliar: buscar nombre
    function getNombrePorCodigo(codigo) {
        const key = String(codigo).trim().replace(/^0+/, "");
        return productosCSVMap[key] || "Desconocido";
    }

   let resultadoHTML = "<h3>Resultados:</h3>";

        // Bot√≥n global para colapsar/expandir todas
        resultadoHTML += `
            <button class="global-toggle-btn" onclick="toggleAllCategories()">
                Colapsar todas las categor√≠as
            </button>
        `;

    // --- Registrados ---
    resultadoHTML += `<p><strong>Registrados (${totalRegistrados}):</strong></p>`;
    if (totalRegistrados === 0) {
        resultadoHTML += '<p class="success">Ninguno</p>';
    } else {
        for (const [categoria, lista] of Object.entries(registradosPorCategoria)) {
            const isCollapsed = collapsedState[categoria] || false;
            resultadoHTML += `
                <div class="categoria-block registrados ${isCollapsed ? 'collapsed' : ''}" data-categoria="${categoria}">
                    <h4 class="categoria-title" onclick="toggleCategory('${categoria}')">
                        ${categoria}
                        <button class="toggle-btn">${isCollapsed ? '' : ''}</button>
                    </h4>
                    <div class="categoria-content">
                        <ul class="codigo-list success">
                            ${lista.map(c => {
                                const nombre = getNombrePorCodigo(c);
                                return `<li><span><strong>${c}</strong> - ${nombre}</span></li>`;
                            }).join("")}
                        </ul>
                    </div>
                </div>`;
        }
    }

    // --- No Registrados ---
    resultadoHTML += `<p><strong>No registrados (${totalNoRegistrados}):</strong></p>`;
    if (totalNoRegistrados === 0) {
        resultadoHTML += '<p class="error">Ninguno</p>';
    } else {
        for (const [categoria, lista] of Object.entries(noRegistradosPorCategoria)) {
            const isCollapsed = collapsedState[categoria] || false;
            resultadoHTML += `
                <div class="categoria-block no-registrados ${isCollapsed ? 'collapsed' : ''}" data-categoria="${categoria}">
                    <h4 class="categoria-title" onclick="toggleCategory('${categoria}')">
                        ${categoria}
                        <button class="toggle-btn">${isCollapsed ? '' : ''}</button>
                    </h4>
                    <div class="categoria-content">
                        <ul class="codigo-list error">
                            ${lista.map(c => {
                                const nombre = getNombrePorCodigo(c);
                                return `
                                    <li>
                                        <label>
                                            <input type="checkbox" class="codigo-checkbox" data-codigo="${c}" ${codigosMarcados[c] ? "checked" : ""}>
                                            <span><strong>${c}</strong> - ${nombre}</span>
                                        </label>
                                    </li>`;
                            }).join("")}
                        </ul>
                    </div>
                </div>`;
        }
    }

    // Renderizar
    container.innerHTML = resultadoHTML;

    // Guardar cambios de los checkboxes
    document.querySelectorAll('.codigo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', e => {
            const codigo = e.target.dataset.codigo;
            codigosMarcados[codigo] = e.target.checked;
            localStorage.setItem('codigosMarcados', JSON.stringify(codigosMarcados));
        });
    });
}


    // Depuraci√≥n: listar algunos c√≥digos sin nombre si los hay (m√°x 20)
    const unknowns = [];
    const allCodigos = [].concat(...Object.values(registradosPorCategoria), ...Object.values(noRegistradosPorCategoria));
    allCodigos.forEach(c => {
        if (getNombrePorCodigo(c) === 'Desconocido') {
            unknowns.push(c);
        }
    });
    if (unknowns.length) {
        console.warn('Codigos sin nombre encontrado (hasta 20):', unknowns.slice(0,20));
    } else {
        console.log('Todos los c√≥digos encontraron nombre (o estaban en productos.js).');
    }


// Funci√≥n para alternar la visibilidad de una categor√≠a
function toggleCategory(categoria) {
    const block = document.querySelector(`.categoria-block[data-categoria="${categoria}"]`);
    const isCollapsed = block.classList.toggle('collapsed');
    const button = block.querySelector('.toggle-btn');
    button.textContent = isCollapsed ? '' : '';

    // Guardar el estado de colapso en localStorage
    const collapsedState = JSON.parse(localStorage.getItem('collapsedCategories') || '{}');
    collapsedState[categoria] = isCollapsed;
    localStorage.setItem('collapsedCategories', JSON.stringify(collapsedState));
}

// Funci√≥n para colapsar o expandir todas las categor√≠as
function toggleAllCategories() {
    const blocks = document.querySelectorAll('.categoria-block');
    const allCollapsed = Array.from(blocks).every(block => block.classList.contains('collapsed'));
    const collapsedState = JSON.parse(localStorage.getItem('collapsedCategories') || '{}');

    blocks.forEach(block => {
        const categoria = block.dataset.categoria;
        if (allCollapsed) {
            block.classList.remove('collapsed');
            block.querySelector('.toggle-btn').textContent = '';
            collapsedState[categoria] = false;
        } else {
            block.classList.add('collapsed');
            block.querySelector('.toggle-btn').textContent = '';
            collapsedState[categoria] = true;
        }
    });

    localStorage.setItem('collapsedCategories', JSON.stringify(collapsedState));
    document.querySelector('.global-toggle-btn').textContent = allCollapsed 
        ? 'Colapsar Todas las Categor√≠as' 
        : 'Expandir Todas las Categor√≠as';
}


    // C√≥digo de admin.html
    const categoryFields = {
        "Cocinas, anafes y purificadores": {
            subcategorias: ["Cocinas", "Anafes", "Purificadores"],
            folders: {
                "Cocinas": "cocinas",
                "Anafes": "anafes",
                "Purificadores": "purificadores"
            },
            fields: {
                "Cocinas": [
                    { label: "Tipo de uso", name: "tipo_uso", type: "select", options: ["Dom√©stico", "Industrial"] },
                    { label: "Dimensiones (Alt x Anc x Pro)", name: "dimensiones", type: "text", placeholder: "85 x 56 x 60" },
                    { label: "V√°lvula de seguridad", name: "valvula_seguridad", type: "select", options: ["S√≠", "No"] },
                    { label: "Luz en el horno", name: "luz_horno", type: "checkbox" },
                    { label: "Encendido el√©ctrico", name: "encendido_electrico", type: "checkbox" },
                    { label: "Timer", name: "timer", type: "checkbox" },
                    { label: "Rejillas de fundici√≥n", name: "rejillas_de_fundicion", type: "checkbox" },
                    { label: "Rejillas de aluminio", name: "rejillas_de_aluminio", type: "checkbox" },
                    { label: "Ladrillos refractarios", name: "ladrillos_refractarios", type: "checkbox" },
                    { label: "Tipo", name: "tipo_de_alimentacion", type: "select", options: ["Envasado", "Natural", "Multigas", "El√©ctrico"] },
                    { label: "Cantidad de hornallas", name: "cantidad_hornallas", type: "text", placeholder: "4" },
                    { label: "Eficiencia energ√©tica", name: "eficiencia", type: "select", options: ["Clase A", "Clase B", "Clase C"] }
                ],
                "Anafes": [
                    { label: "Material de superficie", name: "material_superficie", type: "select", options: ["Vitrocer√°mico", "Inducci√≥n", "Chapa pintada al polvo", "Gas", "Resistencia"] },
                    { label: "Cantidad de hornallas", name: "cantidad_hornallas", type: "text", placeholder: "4" },
                    { label: "Dimensiones (Anc x Pro)", name: "dimensiones", type: "text", placeholder: "60 x 55" },
                    { label: "Encendido el√©ctrico", name: "encendido_electrico", type: "checkbox" },
                    { label: "Timer", name: "timer", type: "checkbox" },
                    { label: "Rejillas de fundici√≥n", name: "rejillas_de_fundicion", type: "checkbox" },
                    { label: "Eficiencia energ√©tica", name: "eficiencia", type: "select", options: ["Clase A", "Clase B", "Clase C"] }
                ],
                "Purificadores": [
                    { label: "Color", name: "color", type: "select", options: ["Blanco", "Acero", "Negro"] },
                    { label: "Funciones", name: "funciones", type: "select", options: ["Purificador y extractor", "Purificador", "Extractor"] },
                    { label: "Cantidad de motores", name: "cantidad_motores", type: "select", options: ["1", "2"] },
                    { label: "Dimensiones (Alt x Anc x Pro)", name: "dimensiones", type: "text", placeholder: "60 x 55" },
                    { label: "Luz", name: "luz", type: "checkbox" }
                ]
            }
        },
        "Heladeras y freezers":  {
            subcategorias: ["Heladeras", "Freezers"],
            folders: {
                "Heladeras": "heladeras",
                "Freezers": "freezers",
            },
            fields: {
                "Heladeras":[
                { label: "Dimensiones (Alt x Anc x Pro)", name: "dimensiones", type: "text", placeholder: "185cm x 60cm x 67cm" },
                { label: "Tipo de tecnolog√≠a", name: "tecnologia", type: "select", options: ["C√≠clica", "No frost"] },
                { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "300" },
                { label: "Freezer", name: "freezer", type: "select", options: ["S√≠", "No"] },
                { label: "Dispenser de agua", name: "dispenser", type: "checkbox" },
                { label: "Inverter", name: "inverter", type: "checkbox" },
                { label: "Eficiencia energ√©tica", name: "eficiencia", type: "text", placeholder: "Clase A" }
            ],
                "Freezers":[
                { label: "Dimensiones (Alt x Anc x Pro)", name: "dimensiones", type: "text", placeholder: "185cm x 60cm x 67cm" },
                { label: "Tipo de tecnolog√≠a", name: "tecnologia", type: "select", options: ["C√≠clica", "No frost"] },
                { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "300" },
                { label: "Freezer", name: "freezer", type: "select", options: ["S√≠", "No"] },
                { label: "Dispenser de agua", name: "dispenser", type: "checkbox" },
                { label: "Inverter", name: "inverter", type: "checkbox" },
                { label: "Eficiencia energ√©tica", name: "eficiencia", type: "text", placeholder: "Clase A" }
            ]
            }
        },
        "Tv y Audio": {
            subcategorias: ["Tv", "Audio"],
            folders: {
                "Tv": "televisores",
                "Audio": "audio"
            },
            fields: {
                "Tv": [
                    { label: "Pulgadas", name: "pulgadas", type: "text", placeholder: "32" },
                    { label: "Tipo de pantalla", name: "tipo_pantalla", type: "text", placeholder: "LED" },
                    { label: "Tipo de resoluci√≥n", name: "resolucion", type: "text", placeholder: "HD" },
                    { label: "Sistema operativo", name: "sistema_operativo", type: "text", placeholder: "Android TV" }
                ],
                "Audio": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "20" },
                    { label: "Bluethoot", name: "bluethoot", type: "checkbox" },
                    { label: "Conectores 3,5", name: "conectores", type: "checkbox" },
                    { label: "USB", name: "usb", type: "checkbox" },
                    { label: "AUX", name: "aux", type: "checkbox" },
                    { label: "Port√°til", name: "portatil", type: "checkbox" },
                    { label: "Micr√≥fono", name: "microfono", type: "checkbox" },
                    { label: "FM", name: "fm", type: "checkbox" },
                    { label: "AM", name: "am", type: "checkbox" },
                ]
            }
        },
        "Tecnolog√≠a": {
            subcategorias: ["Celulares", "Notebooks", "Tablets", "Impresoras"],
            folders: {
                "Celulares": "celulares",
                "Tablets": "tablets",
                "Notebooks": "notebooks",
                "Impresoras": "impresoras"
            },
            fields: {
                "Celulares": [
                    { label: "Almacenamiento (GB)", name: "almacenamiento", type: "text", placeholder: "64" },
                    { label: "RAM (GB)", name: "ram", type: "text", placeholder: "4" },
                    { label: "Pulgadas", name: "pulgadas", type: "text", placeholder: '6,7"' },
                    { label: "C√°mara trasera", name: "camarat", type: "text", placeholder: "32 Mpx" },
                    { label: "C√°mara frontal", name: "camaraf", type: "text", placeholder: "8 Mpx" },
                    { label: "NFC", name: "nfc", type: "select", options: ["No", "S√≠"] },
                    { label: "Bater√≠a", name: "bateria", type: "text", placeholder: "5.2 Ah" },
                    { label: "Red m√≥vil", name: "red", type: "select", options: ["4G", "5G"] },
                    { label: "Sistema operativo", name: "sistema_operativo", type: "text", placeholder: "Android" }
                ],
                "Tablets": [
                    { label: "Almacenamiento (GB)", name: "almacenamiento", type: "text", placeholder: "64" },
                    { label: "RAM (GB)", name: "ram", type: "text", placeholder: "4" },
                    { label: "Pulgadas", name: "pulgadas", type: "text", placeholder: '6,7"' },
                    { label: "C√°mara trasera", name: "camarat", type: "text", placeholder: "32 Mpx" },
                    { label: "C√°mara frontal", name: "camaraf", type: "text", placeholder: "8 Mpx" },
                    { label: "Red m√≥vil", name: "red", type: "checkbox" },
                    { label: "Sistema operativo", name: "sistema_operativo", type: "text", placeholder: "Android" }
                ],
                "Impresoras": [
                    { label: "Tipo de tinta", name: "tinta", type: "select", options: ["Tanque", "Cartuchos", "Laser", "Toner"] },
                    { label: "WIFI", name: "wifi", type: "checkbox" },
                    { label: "Scanner", name: "scanner", type: "checkbox" },
                    { label: "Fotocopias", name: "fotocopias", type: "checkbox" },
                    { label: "Capacidad m√°xima de hojas", name: "capacidad_maxima", type: "text", placeholder: "100" },
                    { label: "Tipo de impresi√≥n", name: "impresion", type: "select", options: ["Color", "Negro"] }
                ],
                "Notebooks": [
                    { label: "Procesador", name: "procesador", type: "text", placeholder: "Intel Core i5" },
                    { label: "RAM (GB)", name: "ram", type: "text", placeholder: "8" },
                    { label: "Almacenamiento (GB)", name: "almacenamiento", type: "text", placeholder: "512 SSD" },
                    { label: "Tama√±o de pantalla (pulgadas)", name: "pulgadas", type: "text", placeholder: "15.6" },
                    { label: "Sistema operativo", name: "sistema_operativo", type: "text", placeholder: "Windows 11" }
                ]
            }
        },
        "Climatizaci√≥n": {
            subcategorias: ["Calefacci√≥n a gas", "Calefacci√≥n el√©ctrica", "Ventilaci√≥n", "Aires Acondicionados"],
            folders: {
                "Calefacci√≥n a gas": "calefaccion_a_gas",
                "Calefacci√≥n el√©ctrica": "calefaccion_electrica",
                "Ventilaci√≥n": "ventilacion",
                "Aires Acondicionados": "aires_acondicionados"
            },
            fields: {
                "Calefacci√≥n a gas": [
                    { label: "Dimensiones (Alt x Anc)", name: "dimensiones", type: "text", placeholder: "63cm x 50cm" },
                    { label: "Tiro balanceado", name: "tiro_balanceado", type: "checkbox" },
                    { label: "Sin salida", name: "sin_salida", type: "checkbox" },
                    { label: "Potencia (Kcal)", name: "potencia", type: "text", placeholder: "2000" },
                    { label: "Tipo de gas", name: "tipo_de_gas", type: "select", options: ["Gas natural", "Multigas", "Gas envasado"] }
                ],
                "Calefacci√≥n el√©ctrica": [
                    { label: "Tipo", name: "tipo", type: "text", placeholder: "Tipo de calefactor" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "2000" },
                    { label: "Termostato", name: "termostato", type: "checkbox" },
                    { label: "Pared", name: "pared", type: "checkbox" },
                    { label: "Control remoto", name: "control_remoto", type: "checkbox" },
                    { label: "Forzador de aire", name: "forzador_aire", type: "checkbox" }
                ],
                "Ventilaci√≥n": [
                    { label: "Tipo", name: "tipo", type: "text", placeholder: "Pie" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "80" },
                    { label: "Pulgadas", name: "pulgadas", type: "text", placeholder: "18" },
                    { label: "Velocidades", name: "velocidades", type: "text", placeholder: "3" },
                    { label: "Tipo de aspas", name: "tipo_aspas", type: "text", placeholder: "Metal" },
                    { label: "Tipo de rejilla", name: "tipo_rejilla", type: "text", placeholder: "Metal" },
                    { label: "Cantidad de aspas", name: "cantidad_aspas", type: "text", placeholder: "3" },
                    { label: "Control remoto", name: "control_remoto", type: "checkbox" },
                    { label: "Oscilaci√≥n", name: "oscilacion", type: "checkbox" },
                    { label: "Orbital", name: "orbital", type: "checkbox" },
                    { label: "Timer", name: "timer", type: "checkbox" },
                    { label: "Repelente", name: "repelente", type: "checkbox" }
                ],
                "Aires Acondicionados": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "12000" },
                    { label: "Tipo", name: "tipo", type: "select", options: ["Split", "Ventana", "Port√°til"] },
                    { label: "Inverter", name: "inverter", type: "checkbox" },
                    { label: "Eficiencia energ√©tica", name: "eficiencia", type: "text", placeholder: "Clase A" }
                ]
            }
        },
        "Lavado": {
            subcategorias: ["Lavarropas", "Lavasecarropas", "Secarropas", "Planchas"],
            folders: {
                "Lavarropas": "lavarropas",
                "Lavasecarropas": "lavasecarropas",
                "Secarropas": "secarropas",
                "Planchas": "planchas"
            },
            fields: {
                "Lavarropas": [
                    { label: "Capacidad (kg)", name: "capacidad", type: "text", placeholder: "7" },
                    { label: "Tipo de lavado", name: "tipo_lavado", type: "select", options: ["Autom√°tico", "Semiautom√°tico"] },
                    { label: "Tipo de carga", name: "tipo_carga", type: "select", options: ["Frontal", "Superior"] },
                    { label: "Velocidad de centrifugado (RPM)", name: "centrifugado", type: "text", placeholder: "1000" },
                    { label: "Inverter", name: "inverter", type: "checkbox" },
                    { label: "WIFI", name: "wifi", type: "checkbox" }
                ],
                "Lavasecarropas": [
                    { label: "Capacidad lavado (kg)", name: "capacidad_lavado", type: "text", placeholder: "8" },
                    { label: "Capacidad secado (kg)", name: "capacidad_secado", type: "text", placeholder: "5" },
                    { label: "Tipo de carga", name: "tipo_carga", type: "select", options: ["Frontal", "Superior"] },
                    { label: "Inverter", name: "inverter", type: "checkbox" },
                    { label: "WIFI", name: "wifi", type: "checkbox" }
                ],
                "Secarropas": [
                    { label: "Capacidad (kg)", name: "capacidad", type: "text", placeholder: "7" },
                    { label: "Tipo de secado", name: "tipo_secado", type: "select", options: ["Centrifugado", "Calor"] },
                    { label: "Velocidad de centrifugado (RPM)", name: "centrifugado", type: "text", placeholder: "2800" },
                    { label: "WIFI", name: "wifi", type: "checkbox" }
                ],
                "Planchas": [
                    { label: "Tipo", name: "tipo", type: "select", options: ["Plancha a vapor", "Plancha en seco"] },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "1200" },
                    { label: "Capacidad de agua (ml)", name: "capacidad_agua", type: "text", placeholder: "200" }
                ]
            }
        },
        "Termotanques y calefones": {
            subcategorias: ["Termotanques", "Calefones"],
            folders: {
                "Termotanques": "termotanques",
                "Calefones": "calefones"
            },
            fields: {
                "Termotanques": [
                    { label: "Tipo", name: "tipo_alimentacion", type: "select", options: ["Gas", "El√©ctrico", "Dual"] },
                    { label: "Dimensiones", name: "dimensiones", type: "text", placeholder: "Alto x ancho" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "80" },
                    { label: "Conexiones", name: "conexiones", type: "select", options: ["Superior", "Inferior", "Ambos"] },
                    { label: "Alta recuperaci√≥n", name: "alta_recuperacion", type: "select", options: ["No", "S√≠"] },
                    { label: "Colgar o apoyar", name: "colgar_apoyar", type: "select", options: ["Colgar", "Apoyar", "Ambos"] },
                    { label: "Eficiencia energ√©tica", name: "eficiencia", type: "select", options: ["Clase E", "Clase D", "Clase C", "Clase B", "Clase A"] }
                ],
                "Calefones": [
                    { label: "Capacidad (L/m)", name: "capacidad", type: "text", placeholder: "14" },
                    { label: "Tiraje", name: "tiraje", type: "select", options: ["Tiro natural", "Tiro balanceado"] },
                    { label: "Tipo de gas", name: "tipo_de_gas", type: "select", options: ["Gas natural", "Gas envasado", "Multigas"] },
                    { label: "Tipo de encendido", name: "encendido", type: "select", options: ["Piezoel√©ctrico", "Autom√°tico", "Manual"] },
                    { label: "Tipo de control", name: "tipo_de_control", type: "select", options: ["Perilla", "Botones", "Corredera"] },
                    { label: "Conexiones de agua", name: "conexiones", type: "select", options: ["Carga inferior"] },
                    { label: "Sin llama piloto", name: "sin_llama_piloto", type: "checkbox" },
                    { label: "Eficiencia energ√©tica", name: "eficiencia", type: "select", options: ["Clase E", "Clase D", "Clase C", "Clase B", "Clase A"] }
                ]
            }
        },
        "Hornos, Microondas y Freidoras": {
            subcategorias: ["Hornos", "Microondas", "Freidoras"],
            folders: {
                "Hornos": "hornos",
                "Microondas": "microondas",
                "Freidoras": "freidoras"
            },
            fields: {
                "Hornos": [
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "25" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "900" },
                    { label: "Anafes", name: "anafes", type: "checkbox" },
                    { label: "Spiedo", name: "spiedo", type: "checkbox" },
                    { label: "Grill", name: "grill", type: "checkbox" },
                    { label: "Conveccion", name: "conveccion", type: "checkbox" }
                ],
                "Microondas": [
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "25" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "900" },
                    { label: "Grill", name: "grill", type: "checkbox" }
                ],
                "Freidoras": [
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "25" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "900" }
                ]
            }
        },
        "Peque√±os": {
            subcategorias: ["Batidoras", "Licuadoras", "Multiprocesadoras", "Mixers", "Pavas el√©ctricas", "Cafeteras", "Tostadoras", "Sandwicheras", "Exprimidores y Jugueras", "Picadoras", "Aspiradoras"],
            folders: {
                "Batidoras": "batidoras",
                "Licuadoras": "licuadoras",
                "Multiprocesadoras": "multiprocesadoras",
                "Mixers": "mixers",
                "Pavas el√©ctricas": "pavas_electricas",
                "Cafeteras": "cafeteras",
                "Tostadoras": "tostadoras",
                "Sandwicheras": "sandwicheras",
                "Exprimidores y Jugueras": "exprimidores_jugueras",
                "Picadoras": "picadoras",
                "Aspiradoras": "aspiradoras"
            },
            fields: {
                "Batidoras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "500" },
                    { label: "Velocidades", name: "velocidades", type: "text", placeholder: "5" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1.5" },
                    { 
                        label: "Accesorios incluidos", 
                        name: "accesorios", 
                        type: "checkbox-group", 
                        options: ["Bowl", "Amasador", "Emulsionador", "Picador de carne", "Mezclador"] 
                    }
                ],
                "Licuadoras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "600" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1.5" },
                    { label: "Jarra de vidrio", name: "jarra_vidrio", type: "checkbox" },
                    { label: "Cuchillas desmontables", name: "cuchillas", type: "select", options: ["S√≠", "No"] }
                ],
                "Multiprocesadoras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "750" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "2" },
                    { label: "Funciones", name: "funciones", type: "text", placeholder: "Picar, triturar, mezclar" }
                ],
                "Mixers": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "400" },
                    { label: "Velocidades", name: "velocidades", type: "text", placeholder: "3" },
                    { label: "Accesorios incluidos", name: "accesorios", type: "text", placeholder: "Batidor, picador" }
                ],
                "Pavas el√©ctricas": [
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1.7" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "2000" },
                    { label: "Apagado autom√°tico", name: "apagado_auto", type: "select", options: ["S√≠", "No"] },
                    { label: "Corte para mate", name: "corte_mate", type: "checkbox" }
                ],
                "Cafeteras": [
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1.2" },
                    { label: "Tipo", name: "tipo", type: "select", options: ["Filtro", "C√°psulas", "Expreso"] },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "600" }
                ],
                "Tostadoras": [
                    { label: "Ranuras", name: "ranuras", type: "text", placeholder: "2" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "800" },
                    { label: "Niveles de tostado", name: "niveles_tostado", type: "text", placeholder: "7" }
                ],
                "Sandwicheras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "700" },
                    { label: "Capacidad (sandwiches)", name: "capacidad", type: "text", placeholder: "2" },
                    { label: "Placas antiadherentes", name: "placas", type: "select", options: ["S√≠", "No"] }
                ],
                "Exprimidores y Jugueras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "400" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1" },
                    { label: "Tipo", name: "tipo", type: "select", options: ["Exprimidor", "Juguera"] }
                ],
                "Picadoras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "500" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "1" },
                    { label: "Cuchillas desmontables", name: "cuchillas", type: "select", options: ["S√≠", "No"] }
                ],
                "Aspiradoras": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "500" },
                    { label: "Capacidad (Litros)", name: "capacidad", type: "text", placeholder: "2,5" },
                    { label: "Apto l√≠quido", name: "apto_liquido", type: "checkbox" },
                    { label: "Bolsa", name: "bolsa", type: "select", options: ["S√≠", "No"] },
                    { label: "Tipo de alimentaci√≥n", name: "tipo_alimentacion", type: "text", placeholder: "Tipo de alimentaci√≥n" }
                ]
            }
        },
        "Cuidado Personal": {
            subcategorias: ["Planchas de Pelo", "Secadores de Pelo", "Cortadoras de Pelo y Barba", "Afeitadoras"],
            folders: {
                "Planchas de Pelo": "planchas_pelo",
                "Secadores de Pelo": "secadores_pelo",
                "Cortadoras de Pelo y Barba": "cortadoras_pelo_barba",
                "Afeitadoras": "afeitadoras"
            },
            fields: {
                "Planchas de Pelo": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "45" },
                    { label: "Material de placas", name: "material", type: "text", placeholder: "Cer√°mica" },
                    { label: "Temperatura m√°xima (¬∞C)", name: "temperatura", type: "text", placeholder: "230" }
                ],
                "Secadores de Pelo": [
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "2000" },
                    { label: "Velocidades", name: "velocidades", type: "text", placeholder: "2" },
                    { label: "Niveles de calor", name: "niveles_calor", type: "text", placeholder: "3" }
                ],
                "Cortadoras de Pelo y Barba": [
                    { label: "Apto pelo", name: "apto_pelo", type: "checkbox" },
                    { label: "Apto barba", name: "apto_barba", type: "checkbox" },
                    { label: "Potencia (W)", name: "potencia", type: "text", placeholder: "5" },
                    { label: "Autonom√≠a (min)", name: "autonomia", type: "text", placeholder: "120" },
                    { label: "Inal√°mbrica", name: "inalambrica", type: "checkbox" },
                    { label: "Peines gu√≠a", name: "peines_guia", type: "text", placeholder: "3 a 12 mm" }
                ],
                "Afeitadoras": [
                    { label: "Tipos de cabezales", name: "tipos_de_cabezales", type: "select", options: ["Rotativo", "Lineal"] },
                    { label: "Autonom√≠a (min)", name: "autonomia", type: "text", placeholder: "75" },
                    { label: "Patillera", name: "patillera", type: "checkbox" },
                    { label: "Inal√°mbrica", name: "inalambrica", type: "checkbox" },
                ]
            }
        },
        "Hogar, Jard√≠n y Tiempo Libre": {
            subcategorias: ["Colchones", "Sommiers", "Almohadas", "Jard√≠n", "Bicicletas", "Piletas"],
            folders: {
                "Colchones": "colchones",
                "Sommiers": "sommiers",
                "Almohadas": "almohadas",
                "Jard√≠n": "jardin",
                "Bicicletas": "bicicletas",
                "Piletas": "piletas"
            },
            fields: {
                "Colchones": [
                    { label: "Plazas", name: "plazas", type: "select", options: ["1", "1 1/2", "2", "Queen size", "King size"] },
                    { label: "Dimensiones (Largo x Ancho x Alto)", name: "dimensiones", type: "text", placeholder: "190 x 80 x 23" },
                    { label: "Peso m√°ximo soportado (Kg)", name: "peso_maximo_soportado", type: "text", placeholder: "80" },
                    { label: "Resortes", name: "resortes", type: "checkbox" },
                    { label: "Espuma", name: "espuma", type: "checkbox" },
                    { label: "Pillow", name: "pillow", type: "checkbox" }
                ],
                "Sommiers": [
                    { label: "Plazas", name: "plazas", type: "select", options: ["1", "1 1/2", "2", "Queen size", "King size"] },
                    { label: "Dimensiones (Largo x Ancho x Alto)", name: "dimensiones", type: "text", placeholder: "190 x 80 x 23" },
                    { label: "Material", name: "material", type: "select", options: ["Madera", "Ca√±o"] },
                    { label: "Forrado", name: "forrado", type: "checkbox" }
                ],
                "Almohadas": [
                    { label: "Materiales del relleno", name: "materiales_del_relleno", type: "text", placeholder: "Fibra de poli√©ster" },
                    { label: "Dimensiones (Largo x Ancho x Espesor)", name: "dimensiones", type: "text", placeholder: "70 x 14 x 40" },
                    { label: "Inteligente", name: "inteligente", type: "checkbox" }
                ],
                "Jard√≠n": [
                    { label: "Tipo de uso", name: "tipo_uso", type: "select", options: ["Cortadora de c√©sped el√©ctrica", "Cortadora de c√©sped nafta", "Bordeadora el√©ctrica", "Desmalezadora"] },
                    { label: "Potencia (HP)", name: "potencia", type: "text", placeholder: "3/4" },
                    { label: "Cilindrada", name: "cilindrada", type: "text", placeholder: "35cc" },
                    { label: "El√©ctrica", name: "electrica", type: "checkbox" },
                    { label: "Nafta", name: "nafta", type: "checkbox" },
                    { label: "Bolsa recolectora", name: "bolsa_recolectora", type: "checkbox" }
                ],
                "Bicicletas": [
                    { label: "Estilo", name: "estilo", type: "select", options: ["Touring", "Mountain Bike", "BMX", "Playera"] },
                    { label: "Material", name: "material", type: "text", placeholder: "Material" },
                    { label: "Rodado", name: "rodado", type: "text", placeholder: "Rodado" },
                    { label: "Tipo de frenos", name: "tipo_de_frenos", type: "select", options: ["V Brake", "Disco", "Contrapedal"] },
                    { label: "Canasto", name: "canasto", type: "checkbox" },
                    { label: "Portaequipaje", name: "portaequipaje", type: "checkbox" }
                ],
                "Piletas": [
                    { label: "Capacidad de agua (L)", name: "capacidad", type: "text", placeholder: "4.600" },
                    { label: "Forma", name: "forma", type: "select", options: ["Rectangular", "Circular"] },
                    { label: "Dimensiones (Cm)", name: "dimensiones", type: "text", placeholder: "300 x 200 x 70" },
                    { label: "Inflable", name: "inflable", type: "checkbox" },
                    { label: "Escalera", name: "escalera", type: "checkbox" }
                ]
            }
        }
    };

    // Agregar previsualizaci√≥n de im√°genes
document.getElementById('imagen').addEventListener('change', function(e) {
    updateImagePreview();
});

document.getElementById('imagenes').addEventListener('change', function(e) {
    updateImagePreview();
});

function updateImagePreview() {
    const imagePreview = document.getElementById('image-preview');
    imagePreview.innerHTML = '';

    const imagenFile = document.getElementById('imagen').files[0];
    const imagenesFiles = document.getElementById('imagenes').files;

    // Previsualizar imagen principal
    if (imagenFile) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(imagenFile);
        img.alt = imagenFile.name;
        img.classList.add('preview-image');
        img.style.maxWidth = '100px';
        img.style.margin = '5px';
        img.onerror = () => {
            img.style.display = 'none';
            const error = document.createElement('p');
            error.textContent = `No se pudo cargar ${imagenFile.name}.`;
            error.style.color = '#ff6b6b';
            imagePreview.appendChild(error);
        };
        imagePreview.appendChild(img);
    }

    // Previsualizar im√°genes adicionales
    Array.from(imagenesFiles).forEach(file => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.alt = file.name;
        img.classList.add('preview-image');
        img.style.maxWidth = '100px';
        img.style.margin = '5px';
        img.onerror = () => {
            img.style.display = 'none';
            const error = document.createElement('p');
            error.textContent = `No se pudo cargar ${file.name}.`;
            error.style.color = '#ff6b6b';
            imagePreview.appendChild(error);
        };
        imagePreview.appendChild(img);
    });

    // Limpiar URLs creados para evitar fugas de memoria
    imagePreview.querySelectorAll('img').forEach(img => {
        img.addEventListener('load', () => URL.revokeObjectURL(img.src));
    });
}

document.getElementById('product-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const categoria = document.getElementById('categoria').value;
    const subcategoria = document.getElementById('subcategoria').value || '';
    const marca = document.getElementById('marca').value.trim();
    const imagenFile = document.getElementById('imagen').files[0];
    const imagenesFiles = document.getElementById('imagenes').files;
    const successMessage = document.getElementById('success-message');

    if (!imagenFile) {
        successMessage.textContent = 'Debes seleccionar una imagen principal.';
        successMessage.style.backgroundColor = '#ff6b6b'; // Color rojo para errores
        successMessage.classList.add('active');
        setTimeout(() => {
            successMessage.classList.remove('active');
        }, 3000);
        return;
    }

    let folder;
    if (categoryFields[categoria]) {
        if (subcategoria && categoryFields[categoria].folders && categoryFields[categoria].folders[subcategoria]) {
            folder = categoryFields[categoria].folders[subcategoria];
        } else {
            folder = categoryFields[categoria].folder || categoria.toLowerCase().replace(/ /g, '_').replace(/,/g, '');
        }
    } else {
        folder = 'images';
    }

    const imagen = imagenFile ? `images/${folder}/${imagenFile.name}` : '';
    const imagenes = Array.from(imagenesFiles).map(file => `images/${folder}/${file.name}`);

    const producto = {
        categoria,
        subcategoria: subcategoria || undefined,
        nombre: document.getElementById('nombre').value,
        codigo: document.getElementById('codigo').value,
        imagen,
        imagenes,
        descripcion: '',
        caracteristicas: [
            `Marca: ${marca || 'Desconocida'}`,
            `Modelo: ${document.getElementById('codigo').value}`,
            'Garant√≠a: 1 a√±o'
        ]
    };

    if (imagen && !producto.imagenes.includes(imagen)) {
        producto.imagenes.unshift(imagen);
    }

    const fields = categoryFields[categoria].fields[subcategoria] || categoryFields[categoria].fields || [];
    let descripcionLines = [];
    fields.forEach(field => {
        const input = document.getElementById(field.name);
        if (field.type === 'checkbox') {
            if (input && input.checked) {
                descripcionLines.push(`<strong>${field.label}:</strong> S√≠`);
            }
        } else if (field.type === 'checkbox-group') {
            const checkboxes = document.querySelectorAll(`input[name="${field.name}[]"]:checked`);
            const selectedOptions = Array.from(checkboxes).map(checkbox => checkbox.value);
            if (selectedOptions.length > 0) {
                descripcionLines.push(`<strong>${field.label}:</strong> ${selectedOptions.join(', ')}`);
            }
        } else if (input && input.value) {
            descripcionLines.push(`<strong>${field.label}:</strong> ${input.value}`);
        }
    });
    producto.descripcion = descripcionLines.join('\n');

    const productos = JSON.parse(localStorage.getItem('productos') || '[]');
    productos.push(producto);
    localStorage.setItem('productos', JSON.stringify(productos));

    loadProducts();
    successMessage.textContent = `¬°Producto "${producto.nombre}" agregado con √©xito!`;
    successMessage.style.backgroundColor = '#008013'; // Color verde para √©xito
    successMessage.classList.add('active');
    setTimeout(() => {
        successMessage.classList.remove('active');
    }, 3000);
    document.getElementById('product-form').reset();
    document.getElementById('subcategoria-group').style.display = 'none';
    document.getElementById('image-preview').innerHTML = '';
    generateDynamicFields('');
});


    function login() {
        const password = document.getElementById('password').value;
        if (password === '') {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            loadProducts();
        } else {
            document.getElementById('login-error').textContent = 'Contrase√±a incorrecta';
        }
    }

    document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
    });

    function updateSubcategories(category) {
        const subcategoriaSelect = document.getElementById('subcategoria');
        const subcategoriaGroup = document.getElementById('subcategoria-group');
        subcategoriaSelect.innerHTML = '<option value="" disabled selected>Selecciona una subcategor√≠a</option>';

        if (category && categoryFields[category].subcategorias.length > 0) {
            subcategoriaGroup.style.display = 'block';
            categoryFields[category].subcategorias.forEach(subcat => {
                const option = document.createElement('option');
                option.value = subcat;
                option.textContent = subcat;
                subcategoriaSelect.appendChild(option);
            });
        } else {
            subcategoriaGroup.style.display = 'none';
        }
    }

    function updateImagePlaceholders(category, subcategoria) {
        const imagenInput = document.getElementById('imagen');
        const imagenesTextarea = document.getElementById('imagenes');
        let folder;

        if (categoryFields[category]) {
            if (subcategoria && categoryFields[category].folders && categoryFields[category].folders[subcategoria]) {
                folder = categoryFields[category].folders[subcategoria];
            } else {
                folder = categoryFields[category].folder || category.toLowerCase().replace(/ /g, '_').replace(/,/g, '');
            }
        } else {
            folder = 'images';
        }

        imagenInput.placeholder = `images/${folder}/nombre_imagen`;
        imagenesTextarea.placeholder = `images/${folder}/nombre_imagen_2\nimages/${folder}/nombre_imagen_3`;
    }

    function generateDynamicFields(category, subcategoria) {
        const dynamicFields = document.getElementById('dynamic-fields');
        dynamicFields.innerHTML = '';

        if (!category || !categoryFields[category]) {
            dynamicFields.innerHTML = '<p>Selecciona una categor√≠a para ver los campos espec√≠ficos.</p>';
            updateImagePlaceholders(category, subcategoria);
            return;
        }

        const fields = categoryFields[category].fields[subcategoria] || categoryFields[category].fields || [];

        fields.forEach(field => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = field.label;
            label.setAttribute('for', field.name);
            formGroup.appendChild(label);

            if (field.type === 'select') {
                const select = document.createElement('select');
                select.id = field.name;
                select.name = field.name;
                field.options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    select.appendChild(opt);
                });
                formGroup.appendChild(select);
            } else if (field.type === 'checkbox') {
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = field.name;
                input.name = field.name;
                formGroup.appendChild(input);
            } else if (field.type === 'checkbox-group') {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-group';
                field.options.forEach(option => {
                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.className = 'checkbox-item';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `${field.name}_${option.toLowerCase().replace(/ /g, '_')}`;
                    input.name = `${field.name}[]`;
                    input.value = option;
                    
                    const optionLabel = document.createElement('label');
                    optionLabel.setAttribute('for', input.id);
                    optionLabel.textContent = option;
                    
                    checkboxWrapper.appendChild(input);
                    checkboxWrapper.appendChild(optionLabel);
                    checkboxContainer.appendChild(checkboxWrapper);
                });
                formGroup.appendChild(checkboxContainer);
            } else {
                const input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
                input.id = field.name;
                input.name = field.name;
                input.placeholder = field.placeholder;
                if (field.type !== 'textarea') input.type = field.type;
                formGroup.appendChild(input);
            }

            dynamicFields.appendChild(formGroup);
        });

        updateImagePlaceholders(category, subcategoria);
    }

    document.getElementById('categoria').addEventListener('change', (e) => {
        const categoria = e.target.value;
        updateSubcategories(categoria);
        generateDynamicFields(categoria, '');
    });

    document.getElementById('subcategoria').addEventListener('change', (e) => {
        const categoria = document.getElementById('categoria').value;
        const subcategoria = e.target.value;
        generateDynamicFields(categoria, subcategoria);
    });

    function loadProducts() {
        const productos = JSON.parse(localStorage.getItem('productos') || '[]');
        const productList = document.getElementById('product-list');
        productList.innerHTML = '';
        productos.forEach((producto, index) => {
            const li = document.createElement('li');
            li.textContent = `${producto.nombre} (${producto.categoria}${producto.subcategoria ? ' - ' + producto.subcategoria : ''}) - C√≥digo: ${producto.codigo}`;
            productList.appendChild(li);
        });
    }

    


    function clearProducts() {
        localStorage.removeItem('productos');
        loadProducts();
        document.getElementById('form-error').textContent = 'Lista de productos limpiada';
    }

    function formatValue(value) {
        if (Array.isArray(value)) {
            return `[\n${value.map(item => `        "${item}"`).join(',\n')}\n    ]`;
        } else if (typeof value === 'string') {
            const escapedValue = value
                .replace(/'/g, "\\'")
                .replace(/\n/g, '\\n');
            return `'${escapedValue}'`;
        }
        return `"${value}"`;
    }

    function formatProducto(producto, indent = '') {
        let output = `{\n${indent}    categoria: "${producto.categoria}",\n`;
        if (producto.subcategoria) {
            output += `${indent}    subcategoria: "${producto.subcategoria}",\n`;
        }
        output += `${indent}    nombre: ${formatValue(producto.nombre)},\n${indent}    imagen: "${producto.imagen}",\n${indent}    imagenes: ${formatValue(producto.imagenes)},\n${indent}    descripcion: ${formatValue(producto.descripcion)},\n${indent}    codigo: "${producto.codigo}",\n${indent}    caracteristicas: ${formatValue(producto.caracteristicas)}\n${indent}}`;
        return output;
    }

    function exportProducts() {
        const productos = JSON.parse(localStorage.getItem('productos') || '[]');
        const jsContent = `const productos = [\n${productos.map(p => `    ${formatProducto(p)}`).join(',\n')}\n];`;
        const blob = new Blob([jsContent], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'productos.js';
        a.click();
        URL.revokeObjectURL(url);
    }

    function populateCategories() {
        const categoriaSelect = document.getElementById('categoria');
        Object.keys(categoryFields).forEach(categoria => {
            const option = document.createElement('option');
            option.value = categoria;
            option.textContent = categoria;
            categoriaSelect.appendChild(option);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateCategories();
        generateDynamicFields('');
    });

    // C√≥digo de admin-stats.html
    function buscarProducto() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const productos = document.querySelectorAll('#productos-mas-vistos .product-card');
        productos.forEach(prod => {
            const nombre = prod.dataset.nombre.toLowerCase();
            prod.style.display = nombre.includes(query) ? 'block' : 'none';
        });
    }

    // Inicializar pesta√±a activa
    document.addEventListener('DOMContentLoaded', () => {
        openTab('verificacion');
    });

    function renderVisitasChart(data) {
    const ctx = document.getElementById('chartVisitas').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: 'Visitas',
                data: Object.values(data),
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
function registrarCompartida(producto) {
    let compartidas = JSON.parse(localStorage.getItem('compartidasProductos')) || {};
    compartidas[producto] = (compartidas[producto] || 0) + 1;
    localStorage.setItem('compartidasProductos', JSON.stringify(compartidas));
    console.log(`Compartida registrada para: ${producto}`);
}

function cargarEstadisticasAvanzadas() {
    const visitas = JSON.parse(localStorage.getItem('visitas')) || {};
    const visitasProductos = JSON.parse(localStorage.getItem('visitasProductos')) || {};
    const uniqueDevices = JSON.parse(localStorage.getItem('uniqueDevices')) || {};
    const compartidasProductos = JSON.parse(localStorage.getItem('compartidasProductos')) || {};

    // Producto m√°s visto
    let productoMasVisto = 'N/A';
    let maxVisitas = 0;
    for (const [producto, cantidad] of Object.entries(visitasProductos)) {
        if (cantidad > maxVisitas) {
            maxVisitas = cantidad;
            productoMasVisto = producto;
        }
    }

    // Cantidad total de visitas
    const totalVisitas = Object.values(visitas).reduce((a, b) => a + b, 0);

    // Cantidad de dispositivos nuevos
    const totalDispositivos = Object.keys(uniqueDevices).length;

    // Total compartidas
    const totalCompartidas = Object.values(compartidasProductos).reduce((a, b) => a + b, 0);

    // Pintar en el panel
    if (document.getElementById('producto-mas-visto'))
        document.getElementById('producto-mas-visto').textContent = productoMasVisto;

    if (document.getElementById('total-visitas'))
        document.getElementById('total-visitas').textContent = totalVisitas;

    if (document.getElementById('total-dispositivos'))
        document.getElementById('total-dispositivos').textContent = totalDispositivos;

    if (document.getElementById('total-compartidas'))
        document.getElementById('total-compartidas').textContent = totalCompartidas;
}

document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('producto-mas-visto')) {
        cargarEstadisticasAvanzadas();
    }
});
function cargarDashboardEstadisticas() {
    const dashboard = document.getElementById('dashboard-estadisticas');
    if (!dashboard) return; // Si no estamos en el dashboard, no hace nada

    const visitas = JSON.parse(localStorage.getItem('visitas')) || {};
    const visitasProductos = JSON.parse(localStorage.getItem('visitasProductos')) || {};
    const uniqueDevices = JSON.parse(localStorage.getItem('uniqueDevices')) || {};
    const compartidasProductos = JSON.parse(localStorage.getItem('compartidasProductos')) || {};

    // Producto m√°s visto
    let productoMasVisto = 'N/A';
    let maxVisitas = 0;
    for (const [producto, cantidad] of Object.entries(visitasProductos)) {
        if (cantidad > maxVisitas) {
            maxVisitas = cantidad;
            productoMasVisto = producto;
        }
    }

    // Total visitas
    const totalVisitas = Object.values(visitas).reduce((a, b) => a + b, 0);

    // Total dispositivos nuevos
    const totalDispositivos = Object.keys(uniqueDevices).length;

    // Total compartidas
    const totalCompartidas = Object.values(compartidasProductos).reduce((a, b) => a + b, 0);

    // Pintar en tarjetas
    document.getElementById('producto-mas-visto').textContent = productoMasVisto;
    document.getElementById('total-visitas').textContent = totalVisitas;
    document.getElementById('total-dispositivos').textContent = totalDispositivos;
    document.getElementById('total-compartidas').textContent = totalCompartidas;

    // Gr√°fico de visitas por producto
    if (Object.keys(visitasProductos).length > 0) {
        const ctx = document.getElementById('chartVisitasProductos').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(visitasProductos),
                datasets: [{
                    label: 'Visitas',
                    data: Object.values(visitasProductos),
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', cargarDashboardEstadisticas);



</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
