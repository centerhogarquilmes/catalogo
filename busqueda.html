<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categoría - Center Hogar Quilmes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="images/logo.webp" type="image/x-icon">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <img src="images/logo_trans.png" alt="Center Hogar Quilmes" class="logo-img">
                    </a>
                </div>
                <div class="header-actions">
                    <button class="menu-toggle" aria-label="Abrir menú de navegación">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="header-contact">
                    <div class="contact-item">
                        <p><a href="https://api.whatsapp.com/send?phone=5491131680489&text=Hola,%20tengo%20una%20consulta" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="contact-icon">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                            </svg>
                            11 3168-0489
                        </a></p>
                </div>
                <div class="contact-item">
                    <p><a href="https://maps.app.goo.gl/MGt4KohJ75XAGDWn8" target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="contact-icon">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        Rivadavia 220
                        </a></p>
                </div>
                
        </div>
    </div>
    
            <div class="search-bar">
                <div class="search-bar-input-container">
                    <input type="text" placeholder="Buscar productos..." id="searchInput" autocomplete="off">
                    <button class="search-btn">
                        <img src="images/lupa.png" alt="Buscar" class="search-icon">
                    </button>
                </div>
                <div class="suggestions" id="suggestions" style="display: none;"></div>
            </div>
            <nav class="nav-menu" id="nav-menu">
    <ul>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Cocinas y anafes">Cocinas y<br>anafes</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Cocinas y anafes&subcategoria=Cocinas">Cocinas</a></li>
                <li><a href="categoria.html?nombre=Cocinas y anafes&subcategoria=Anafes">Anafes</a></li>
            </ul>
        </li>
        <li><a href="categoria.html?nombre=Heladeras">Heladeras</a></li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Tv y audio">Tv y Audio</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Tv y audio&subcategoria=Tv">Tv</a></li>
                <li><a href="categoria.html?nombre=Tv y audio&subcategoria=Audio">Audio</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Tecnologia">Tecnología</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Tecnologia&subcategoria=Celulares">Celulares</a></li>
                <li><a href="categoria.html?nombre=Tecnologia&subcategoria=Tablets">Tablets</a></li>
                <li><a href="categoria.html?nombre=Tecnologia&subcategoria=Notebooks">Notebooks</a></li>
                <li><a href="categoria.html?nombre=Tecnologia&subcategoria=Impresoras">Impresoras</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Climatizacion">Climatización</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Climatizacion&subcategoria=Calefaccion electrica">Calefacción eléctrica</a></li>
                <li><a href="categoria.html?nombre=Climatizacion&subcategoria=Calefaccion a gas">Calefacción a gas</a></li>
                <li><a href="categoria.html?nombre=Climatizacion&subcategoria=Ventilacion">Ventilación</a></li>
                <li><a href="categoria.html?nombre=Climatizacion&subcategoria=Aires acondicionados">Aires Acondicionados</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Hornos, microondas y freidoras">Hornos, Microondas<br>y freidoras</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Hornos, microondas y freidoras&subcategoria=Hornos">Hornos</a></li>
                <li><a href="categoria.html?nombre=Hornos, microondas y freidoras&subcategoria=Microondas">Microondas</a></li>
                <li><a href="categoria.html?nombre=Hornos, microondas y freidoras&subcategoria=Freidoras">Freidoras</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Lavado">Lavado</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Lavado&subcategoria=Lavarropas">Lavarropas</a></li>
                <li><a href="categoria.html?nombre=Lavado&subcategoria=Lavasecarropas">Lavasecarropas</a></li>
                <li><a href="categoria.html?nombre=Lavado&subcategoria=Secarropas">Secarropas</a></li>
                <li><a href="categoria.html?nombre=Lavado&subcategoria=Planchas">Planchas</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Termotanques y calefones">Termotanques<br>y calefones</a>
            <ul class="submenu">
                
                <li><a href="categoria.html?nombre=Termotanques y calefones&subcategoria=Termotanques">Termotanques</a></li>
                <li><a href="categoria.html?nombre=Termotanques y calefones&subcategoria=Calefones">Calefones</a></li>
            </ul>
        </li><li class="has-submenu">
            <a href="categoria.html?nombre=Pequeños">Pequeños<br>electrodomésticos</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=batidoras">batidoras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Licuadoras">Licuadoras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Multiprocesadoras">Multiprocesadoras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Mixers">Mixers</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=pavas electricas">pavas electricas</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Cafeteras">Cafeteras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Tostadoras">Tostadoras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Sandwicheras">Sandwicheras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subCategoria=Exprimidores y jugueras">Exprimidores y Jugueras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Picadoras">Picadoras</a></li>
                <li><a href="categoria.html?nombre=Pequeños&subcategoria=Aspiradoras">Aspiradoras</a></li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="categoria.html?nombre=Cuidado personal">Cuidado Personal</a>
            <ul class="submenu">
                <li><a href="categoria.html?nombre=Cuidado personal&subcategoria=Planchas de pelo">Planchas de Pelo</a></li>
                <li><a href="categoria.html?nombre=Cuidado personal&subcategoria=Secadores de pelo">Secadores de Pelo</a></li>
                <li><a href="categoria.html?nombre=Cuidado personal&subcategoria=Cortadoras de pelo y barba">Cortadoras de Pelo y Barba</a></li>
            </ul>
        </li>
    </ul>
</nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <section class="catalog">
            <div class="search-container">
                <div class="filter-panel">
                    <button class="filter-toggle" aria-label="Abrir filtros">Filtros ☰</button>
                    <div class="filters" id="filters">
                        <h3>Filtros</h3>
                        <div class="filter-group">
                            <h4>Marca</h4>
                            <select id="filter-marca">
                                <option value="">Todas</option>
                                <!-- Opciones generadas dinámicamente -->
                            </select>
                        </div>
                        <div id="dynamic-filters">
                            <!-- Filtros dinámicos se generan aquí -->
                        </div>
                        <div class="filter-buttons">
                            <button class="clear-filters buy-btn">Limpiar</button>
                        </div>
                    </div>
                </div>
                <div class="results">
                    <h2 id="category-title">Productos</h2>
                        <div class="view-toggle" id="view-toggle">
                            <button class="view-btn grid-view active" data-view="grid" title="Vista en mosaico" aria-label="Vista en mosaico">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                </svg>
                            </button>
                            <button class="view-btn list-view" data-view="list" title="Vista en lista" aria-label="Vista en lista">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <line x1="3" y1="12" x2="21" y2="12"></line>
                                    <line x1="3" y1="18" x2="21" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    <div class="active-filters" id="active-filters">
                        <!-- Filtros activos se muestran aquí -->
                    </div>
                    <div class="product-grid" id="product-grid">
                        <!-- Productos se llenan con JavaScript -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
    <div class="container">
        <p>© 2025 Center Hogar Quilmes. Todos los derechos reservados.</p>
        <ul>
            <li><a href="terminos.html">Términos y condiciones</a></li>
            <li><a href="contacto.html">Contacto</a></li>
            <li><a href="privacidad.html">Privacidad</a></li>
            <li><a href="garantia.html">Políticas de garantías</a></li>
        </ul>
    </div>
    </footer>

    <!-- Botón flotante para filtros -->
<button class="filter-float" title="Abrir filtros" aria-label="Abrir filtros">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" y1="6" x2="20" y2="6"></line>
        <line x1="4" y1="12" x2="20" y2="12"></line>
        <line x1="4" y1="18" x2="20" y2="18"></line>
        <circle cx="8" cy="6" r="1"></circle>
        <circle cx="8" cy="12" r="1"></circle>
        <circle cx="8" cy="18" r="1"></circle>
    </svg>
</button>

    <!-- Botón flotante para volver arriba -->
   <button class="scroll-to-top" title="Volver arriba">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5"></path>
            <path d="M5 12l7-7 7 7"></path>
        </svg>
    </button>

    <!-- Scripts -->
<script src="precios.js"></script>
<script src="productos.js"></script>
<script src="scripts.js"></script>
<script>
// Definir atributos filtrables por categoría
const atributosPorCategoria = {
    "lavado": [
        "Tipo de lavado",
        "Capacidad (kg)",
        "Inverter",
        "Velocidad de centrifugado (RPM)",
        "Tipo de carga"
    ],
    "tv y audio": [
        "Pulgadas",
        "Tipo de resolución",
        "Dimensiones",
        "Tipo de pantalla",
        "Sistema operativo"
    ],
    "tecnologia": [
        "Sistema operativo",
        "Almacenamiento",
        "Bateria",
        "NFC",
        "Cámara trasera",
        "Cámara frontal",
        "Red móvil",
        "RAM (GB)"
    ],
    "climatizacion": {
        "calefaccion electrica": [
            "Potencia (W)",
            "Cantidad de velas",
            "Giratoria"
        ],
        "calefaccion a gas": [
            "Potencia (Kcal)",
            "Tipo",
            "Tipo de gas",
            "Tipo"
        ]
    },
    "cocinas": [
        "Tipo de uso",
        "Dimensiones",
        "Material",
        "Tipo de gas",
        "Encendido eléctrico",
        "Válvula de seguridad",
        "Luz en el horno",
        "Hornallas"
    ],
    "heladeras": [
        "Dimensiones",
        "Capacidad (Litros)",
        "Tipo de tecnologia",
        "Inverter",
        "Dispenser de agua",
        "Tipo de heladera",
        "Eficiencia energética"
    ],
    "hornos, microondas y freidoras": [
        "Convector",
        "Anafes",
        "Spiedo",
        "Grill",
        "Capacidad (litros)",
        "Potencia (W)"
    ],
    "termotanques": [
        "Dimensiones",
        "Capacidad (Litros)",
        "Conexiones",
        "Alta recuperación",
        "Colgar o apoyar",
        "Potencia",
        "Eficiencia energética"
    ],
    "Pequeños": {
        "Pavas eléctricas": [
            "Capacidad (Litros)",
            "Potencia (W)",
            "Corte automático"
        ],
        "cafeteras": [
            "Capacidad (Litros)",
            "Tipo",
            "Potencia (W)"
        ],
        "tostadoras": [
            "Ranuras",
            "Potencia (W)",
            "Niveles de tostado"
        ]
    },
    "cuidado personal": [
        "Tipo de equipo",
        "Uso recomendado",
        "Potencia (W)"
    ]
};

// Función para parsear el campo descripción y convertirlo en un objeto de atributos
function parsearDescripcion(descripcion) {
    const atributos = {};
    if (!descripcion) return atributos;

    const lineas = descripcion.split('\n');
    lineas.forEach(linea => {
        const match = linea.match(/<strong>([^:]+):<\/strong>\s*(.+)/);
        if (match) {
            const clave = match[1].trim();
            const valor = match[2].trim();
            atributos[clave] = valor;
        }
    });

    // Inferir "Smart TV" basado en "Sistema operativo"
    if (atributos["Sistema operativo"]) {
        const sistemasSmart = ["Android TV", "Google TV", "Titan OS", "Tyzen", "Vidaa", "GO"];
        atributos["Smart TV"] = sistemasSmart.includes(atributos["Sistema operativo"]) ? "Sí" : "No";
    }

    return atributos;
}

// Normalizar texto para manejar acentos y mayúsculas/minúsculas
function normalizeString(input) {
    if (Array.isArray(input)) {
        input = input.join(' ');
    }
    if (typeof input !== 'string') {
        input = String(input || '');
    }
    return input.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
}

// Obtener elementos del DOM
const searchInput = document.getElementById('searchInput');
const searchBtn = document.querySelector('.search-btn');
const suggestionsContainer = document.getElementById('suggestions');
const filterMarca = document.getElementById('filter-marca');
const productGrid = document.getElementById('product-grid');
const categoryTitle = document.getElementById('category-title');
const dynamicFiltersContainer = document.getElementById('dynamic-filters');
const activeFiltersContainer = document.getElementById('active-filters');

// Obtener parámetros de la URL
const urlParams = new URLSearchParams(window.location.search);
let searchQuery = urlParams.get('q') || urlParams.get('query') || ''; // Soporte para ambos parámetros
searchInput.value = searchQuery;
console.log('Parámetro inicial de búsqueda:', searchQuery);

// Obtener marcas únicas de todos los productos
const marcas = [...new Set(
    productos
        .map(p => p.caracteristicas.find(c => c.startsWith('Marca: '))?.replace('Marca: ', ''))
        .filter(m => m)
)];
marcas.forEach(marca => {
    const option = document.createElement('option');
    option.value = marca;
    option.textContent = marca;
    filterMarca.appendChild(option);
});

// Generar filtros dinámicos según los productos filtrados
function updateDynamicFilters(productosFiltrados) {
    console.log('Ejecutando updateDynamicFilters con', productosFiltrados.length, 'productos');
    dynamicFiltersContainer.innerHTML = '';
    const categoriasUnicas = [...new Set(productosFiltrados.map(p => normalizeString(p.categoria)))];
    let atributosFiltrables = [];

    categoriasUnicas.forEach(categoria => {
        if (atributosPorCategoria[categoria]) {
            if (typeof atributosPorCategoria[categoria] === 'object' && !Array.isArray(atributosPorCategoria[categoria])) {
                Object.values(atributosPorCategoria[categoria]).forEach(subAttrs => {
                    atributosFiltrables.push(...subAttrs);
                });
            } else {
                atributosFiltrables.push(...atributosPorCategoria[categoria]);
            }
        }
    });
    atributosFiltrables = [...new Set(atributosFiltrables)];

    if (atributosFiltrables.length === 0) return;

    atributosFiltrables.forEach(atributo => {
        let valoresUnicos = [...new Set(
            productosFiltrados
                .map(p => parsearDescripcion(p.descripcion)[atributo])
                .filter(v => v && v !== '-' && v !== '0')
        )];

        if (valoresUnicos.length === 0) return;

        // Ordenar valores numéricos para atributos específicos
        if (atributo === 'Capacidad (Litros)' || atributo === 'Capacidad' || atributo === 'Pulgadas' || atributo === 'Capacidad (kg)' || 
            atributo === 'Potencia' || atributo === 'Potencia (W)' || atributo === 'Velocidad de centrifugado (RPM)' || 
            atributo === 'Cámara trasera' || atributo === 'Cámara frontal' || atributo === 'Hornallas' || 
            atributo === 'Presión (bar)' || atributo === 'Niveles de tostado') {
            valoresUnicos.sort((a, b) => {
                const numA = parseFloat(a.replace(/[^\d.]/g, '')) || 0;
                const numB = parseFloat(b.replace(/[^\d.]/g, '')) || 0;
                return numA - numB;
            });
        } else {
            valoresUnicos.sort((a, b) => a.localeCompare(b));
        }

        const filterGroup = document.createElement('div');
        filterGroup.className = 'filter-group collapsible-filter';

        const filterHeader = document.createElement('h4');
        filterHeader.textContent = atributo;
        filterHeader.className = 'collapsible-header';
        filterHeader.addEventListener('click', () => {
            filterHeader.classList.toggle('active');
            filterContent.style.display = filterHeader.classList.contains('active') ? 'block' : 'none';
        });

        const filterContent = document.createElement('div');
        filterContent.className = 'collapsible-content';
        filterContent.style.display = 'none';

        valoresUnicos.forEach(valor => {
            const label = document.createElement('label');
            label.className = 'filter-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = `filter-${normalizeString(atributo)}`;
            checkbox.value = valor;
            checkbox.className = 'filter-checkbox';
            checkbox.addEventListener('change', () => {
                console.log('Filtro dinámico cambiado:', atributo, valor);
                filtrarProductos();
            });

            const span = document.createElement('span');
            span.textContent = valor;

            label.appendChild(checkbox);
            label.appendChild(span);
            filterContent.appendChild(label);
        });

        filterGroup.appendChild(filterHeader);
        filterGroup.appendChild(filterContent);
        dynamicFiltersContainer.appendChild(filterGroup);
    });
}

// Actualizar título según la búsqueda
function updateTitle() {
    let title = searchQuery ? `Resultados para "${searchQuery}"` : 'Buscar Productos';
    categoryTitle.textContent = title;
    console.log('Título actualizado:', title);
}
updateTitle();

// Función para mostrar sugerencias
function mostrarSugerencias() {
    const query = normalizeString(searchInput.value);
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.style.display = 'none';

    if (query.length < 2) return;

    const productosSugeridos = productos
        .filter(producto => {
            const nombre = normalizeString(producto.nombre);
            const descripcion = normalizeString(producto.descripcion);
            const caracteristicas = normalizeString(producto.caracteristicas);
            return nombre.includes(query) || descripcion.includes(query) || caracteristicas.includes(query);
        })
        .slice(0, 5);

    if (productosSugeridos.length === 0) return;

    productosSugeridos.forEach(producto => {
        const suggestion = document.createElement('div');
        suggestion.className = 'suggestion-item';
        suggestion.textContent = producto.nombre;
        suggestion.addEventListener('click', () => {
            console.log('Sugerencia seleccionada:', producto.nombre);
            searchInput.value = producto.nombre;
            searchQuery = producto.nombre;
            suggestionsContainer.style.display = 'none';
            updateTitle();
            filtrarProductos();
        });
        suggestionsContainer.appendChild(suggestion);
    });

    suggestionsContainer.style.display = 'block';
}

// Función para mostrar los filtros activos
function mostrarFiltrosActivos() {
    activeFiltersContainer.innerHTML = '';

    // Marca
    if (filterMarca.value) {
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        chip.innerHTML = `
            <span>Marca: ${filterMarca.value}</span>
            <button data-filter="marca">×</button>
        `;
        activeFiltersContainer.appendChild(chip);
    }

    // Filtros dinámicos
    const filterGroups = dynamicFiltersContainer.querySelectorAll('.filter-group');
    filterGroups.forEach(group => {
        const atributo = group.querySelector('.collapsible-header').textContent;
        const checkboxes = group.querySelectorAll('.filter-checkbox:checked');
        checkboxes.forEach(checkbox => {
            const valor = checkbox.value;
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerHTML = `
                <span>${atributo}: ${valor}</span>
                <button data-filter="dynamic" data-atributo="${atributo}" data-valor="${valor}">×</button>
            `;
            activeFiltersContainer.appendChild(chip);
        });
    });

    // Agregar evento para eliminar filtros
    activeFiltersContainer.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
            console.log('Eliminando filtro:', button.dataset.filter);
            const filterType = button.dataset.filter;
            if (filterType === 'marca') {
                filterMarca.value = '';
            } else if (filterType === 'dynamic') {
                const atributo = button.dataset.atributo;
                const valor = button.dataset.valor;
                const checkbox = document.querySelector(`input[name="filter-${normalizeString(atributo)}"][value="${valor}"]`);
                if (checkbox) checkbox.checked = false;
            }
            filtrarProductos();
        });
    });
}

// Función para filtrar productos
function filtrarProductos() {
    console.log('Ejecutando filtrarProductos con searchQuery:', searchQuery);
    let productosFiltrados = productos;

    // Filtrar por término de búsqueda
if (searchQuery) {
    const queryNormalizada = normalizeString(searchQuery);
    productosFiltrados = productosFiltrados.filter(producto => {
        const nombre = normalizeString(producto.nombre);
        const descripcion = normalizeString(producto.descripcion);
        const caracteristicas = normalizeString(producto.caracteristicas);
        const codigo = normalizeString(producto.codigo || ''); // Incluir el código
        return nombre.includes(queryNormalizada) || 
               descripcion.includes(queryNormalizada) || 
               caracteristicas.includes(queryNormalizada) || 
               codigo.includes(queryNormalizada);
    });
    console.log('Productos tras búsqueda:', productosFiltrados.length);
}

    // Filtrar por marca
    const marca = filterMarca.value;
    if (marca) {
        productosFiltrados = productosFiltrados.filter(producto => 
            producto.caracteristicas.some(c => c === `Marca: ${marca}`)
        );
        console.log('Productos tras filtro de marca:', productosFiltrados.length);
    }

    // Filtrar por atributos dinámicos
    const filterGroups = dynamicFiltersContainer.querySelectorAll('.filter-group');
    filterGroups.forEach(group => {
        const checkboxes = group.querySelectorAll('.filter-checkbox:checked');
        if (checkboxes.length > 0) {
            const atributo = group.querySelector('.collapsible-header').textContent;
            const valoresSeleccionados = Array.from(checkboxes).map(checkbox => checkbox.value);
            productosFiltrados = productosFiltrados.filter(producto => {
                const atributos = parsearDescripcion(producto.descripcion);
                const valorAtributo = atributos[atributo];
                return valorAtributo && valoresSeleccionados.includes(valorAtributo);
            });
            console.log(`Productos tras filtro ${atributo}:`, productosFiltrados.length);
        }
    });

    // Mostrar productos
    productGrid.innerHTML = '';
    if (productosFiltrados.length === 0) {
        productGrid.innerHTML = `
            <div class="no-results">
                <img src="images/nomedia_trans.png" alt="No se encontraron resultados">
                <p>No se han encontrado resultados</p>
            </div>
        `;
    } else {
        productosFiltrados.forEach(producto => {
            // Obtener datos desde precios.js
            const datosDinamicos = precios && precios[producto.codigo] ? precios[producto.codigo] : { precio_tarjeta: 'No disponible', stock_sucursal: 0, stock_deposito: 0 };
            const precioLista = datosDinamicos.precio_tarjeta !== 'No disponible' ? parseFloat(datosDinamicos.precio_tarjeta) : null;
            const precioTextoLista = precioLista ? `$${precioLista.toLocaleString('es-AR')}` : 'Consultar precio';
            // Modificar esta línea si cambia el porcentaje de Pre. ant. imp. nac. (actualmente 0.8265)
            const precioAntesImpuestos = precioLista ? `$${(precioLista * 0.8265).toLocaleString('es-AR', { minimumFractionDigits: 2 })}` : 'Consultar precio';
            const isAgotado = datosDinamicos.stock_sucursal + datosDinamicos.stock_deposito === 0;

            const card = document.createElement('div');
            card.className = `product-card ${isAgotado ? 'agotado' : ''}`;
            card.innerHTML = `
                <a href="producto.html?nombre=${encodeURIComponent(producto.nombre)}&categoria=${encodeURIComponent(producto.categoria)}&subcategoria=${encodeURIComponent(producto.subcategoria || '')}&imagen=${encodeURIComponent(producto.imagen)}&imagenes=${producto.imagenes.map(img => encodeURIComponent(img)).join(',')}&descripcion=${encodeURIComponent(producto.descripcion)}&caracteristicas=${producto.caracteristicas.map(c => encodeURIComponent(c)).join(',')}">
                    ${isAgotado ? '<span class="agotado-label">Agotado</span>' : ''}
                    <img src="${producto.imagen}" alt="${producto.nombre}" onerror="this.onerror=null; this.src='images/nomedia_trans.png';">
                    <div class="text-container">
                        <h3>${producto.nombre}</h3>
                        <p class="product-price">Precio de lista: ${precioTextoLista}</p>
                        <p class="product-price-before-tax">Pre. ant. imp. nac.: ${precioAntesImpuestos}</p>
                        <button class="buy-btn">Ver detalles</button>
                    </div>
                </a>
            `;
            productGrid.appendChild(card);
        });
    }

    // Actualizar URL usando 'q' para consistencia
    const params = new URLSearchParams();
    if (searchQuery) params.set('q', searchQuery);
    history.replaceState(null, '', `busqueda.html?${params.toString()}`);
    console.log('URL actualizada:', window.location.href);

    // Mostrar filtros activos
    mostrarFiltrosActivos();

    // Actualizar filtros dinámicos
    setTimeout(() => updateDynamicFilters(productosFiltrados), 0);
}

// Configurar eventos de búsqueda
let isProcessingSearch = false; // Evitar recargas múltiples
searchInput.addEventListener('input', () => {
    console.log('Input en searchInput:', searchInput.value);
    if (!isProcessingSearch) mostrarSugerencias();
});
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !isProcessingSearch) {
        console.log('Enter presionado con:', searchInput.value);
        isProcessingSearch = true;
        searchQuery = searchInput.value.trim();
        updateTitle();
        filtrarProductos();
        suggestionsContainer.style.display = 'none';
        setTimeout(() => isProcessingSearch = false, 100); // Desbloquear tras un breve delay
        e.preventDefault(); // Prevenir redirección de scripts.js
    }
});
searchBtn.addEventListener('click', (e) => {
    if (!isProcessingSearch) {
        console.log('Botón de búsqueda clickeado con:', searchInput.value);
        isProcessingSearch = true;
        searchQuery = searchInput.value.trim();
        updateTitle();
        filtrarProductos();
        suggestionsContainer.style.display = 'none';
        setTimeout(() => isProcessingSearch = false, 100);
        e.preventDefault(); // Prevenir redirección de scripts.js
    }
});

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', (e) => {
    if (!suggestionsContainer.contains(e.target) && e.target !== searchInput) {
        suggestionsContainer.style.display = 'none';
    }
});

// Configurar eventos de filtros
filterMarca.addEventListener('change', () => {
    console.log('Filtro de marca cambiado:', filterMarca.value);
    filtrarProductos();
});
document.querySelector('.clear-filters').addEventListener('click', () => {
    console.log('Limpiando filtros');
    filterMarca.value = '';
    const checkboxes = dynamicFiltersContainer.querySelectorAll('.filter-checkbox:checked');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    searchQuery = searchInput.value.trim(); // Mantener la búsqueda
    updateTitle();
    filtrarProductos();
});

// Ejecutar filtrado inicial
console.log('Filtrado inicial con searchQuery:', searchQuery);
filtrarProductos();
</script>
</body>
</html>