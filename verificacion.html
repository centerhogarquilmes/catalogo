<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Códigos</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            background-color: #f8f9fa;
            color: #333;
        }
        h2, h3 {
            color: #1a73e8;
            font-weight: 500;
        }
        textarea {
            width: 100%;
            height: 120px;
            resize: vertical;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s;
        }
        textarea:focus {
            border-color: #1a73e8;
            outline: none;
        }
        button {
            padding: 12px 24px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            margin: 10px 0;
        }
        button:hover {
            background-color: #1557b0;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        #csvInput {
            margin-top: 10px;
            font-size: 14px;
        }
        #fileStatus {
            margin-top: 8px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
        }
        #fileStatus.success {
            background-color: #d4edda;
            color: #155724;
        }
        #fileStatus.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background-color: #e9ecef;
            font-weight: 500;
        }
        tr.highlight {
            background-color: #fff3cd;
        }
        .success {
            color: #28a745;
            font-weight: 500;
        }
        .error {
            color: #dc3545;
            font-weight: 500;
        }
        @media (max-width: 600px) {
            body {
                margin: 10px;
            }
            button {
                width: 100%;
            }
            table, th, td {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <h2>Verificador de Códigos de Productos</h2>
    <p>Ingrese los códigos separados por comas o uno por línea:</p>
    <textarea id="codigosInput" placeholder="Ejemplo: 18079, 12345, 67890"></textarea>
    <br>
    <button onclick="verificarManual()">Verificar Manual</button>
    
    <h3>Cargar archivo CSV</h3>
    <input type="file" id="csvInput" accept=".csv" onchange="procesarCSV()">
    <div id="fileStatus"></div>
    
    <div id="resultado"></div>

    <!-- Incluir productos.js -->
    <script src="productos.js"></script>
    <script>
        let csvContent = null; // Variable global para almacenar el contenido del CSV
        let codigoToCategoria = {}; // Mapa para almacenar códigos y sus categorías del CSV

        function verificarManual() {
            const input = document.getElementById('codigosInput').value;
            const codigos = input.split(/[\n,]+/).map(c => c.trim()).filter(c => c);
            verificarYMostrar(codigos);
        }

        function procesarCSV() {
            const fileInput = document.getElementById('csvInput');
            const fileStatus = document.getElementById('fileStatus');
            const file = fileInput.files[0];

            if (!file) {
                fileStatus.innerHTML = '<span class="error">No se seleccionó ningún archivo.</span>';
                fileStatus.className = 'error';
                return;
            }

            if (!file.name.endsWith('.csv')) {
                fileStatus.innerHTML = '<span class="error">Por favor, seleccione un archivo CSV.</span>';
                fileStatus.className = 'error';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                csvContent = e.target.result; // Almacenar el contenido del CSV
                const codigos = parsearCSV(csvContent);
                if (codigos.length === 0) {
                    fileStatus.innerHTML = '<span class="error">No se encontraron códigos válidos en el archivo.</span>';
                    fileStatus.className = 'error';
                    return;
                }
                fileStatus.innerHTML = `Archivo cargado: ${codigos.length} códigos encontrados.`;
                fileStatus.className = 'success';
                console.log('Mapa de códigos a categorías:', codigoToCategoria); // Depuración
                verificarYMostrar(codigos);
            };
            reader.onerror = function() {
                fileStatus.innerHTML = '<span class="error">Error al leer el archivo.</span>';
                fileStatus.className = 'error';
            };
            reader.readAsText(file);
        }

        function parsearCSV(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length === 0) return [];

            // Limpiar encabezados
            const headers = lines[0].split(';').map(h => h.trim().replace(/^"|"$/g, ''));
            console.log('Encabezados del CSV:', headers); // Depuración

            // Buscar índices de columnas, siendo flexible con tildes y codificaciones
            const articuloIndex = headers.findIndex(h => 
                h === 'Artículo' || h === 'Art�culo' || h.toLowerCase() === 'articulo' || h.toLowerCase() === 'art�culo'
            );
            const agrupacionIndex = headers.findIndex(h => 
                h === 'Agrupación' || h === 'Agrupaciòn' || h === 'Agrupaci�n' || h.toLowerCase() === 'agrupacion' || h.toLowerCase() === 'agrupaciòn' || h.toLowerCase() === 'agrupaci�n'
            );

            if (articuloIndex === -1) {
                document.getElementById('fileStatus').innerHTML = '<span class="error">No se encontró la columna "Artículo" en el CSV.</span>';
                document.getElementById('fileStatus').className = 'error';
                console.warn('Columna "Artículo" no encontrada en el CSV. Encabezados:', headers);
                return [];
            }
            if (agrupacionIndex === -1) {
                document.getElementById('fileStatus').innerHTML = '<span class="error">No se encontró la columna "Agrupaciòn" en el CSV.</span>';
                document.getElementById('fileStatus').className = 'error';
                console.warn('Columna "Agrupaciòn" no encontrada en el CSV. Encabezados:', headers);
                return [];
            }

            // Extraer códigos y categorías
            const codigos = [];
            codigoToCategoria = {}; // Reiniciar el mapa
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split(';').map(c => c.trim().replace(/^"|"$/g, ''));
                if (columns[articuloIndex]) {
                    const codigo = columns[articuloIndex];
                    codigos.push(codigo);
                    codigoToCategoria[codigo] = columns[agrupacionIndex] ? columns[agrupacionIndex] : 'Sin categoría';
                    console.log(`Código: ${codigo}, Categoría: ${codigoToCategoria[codigo]}`); // Depuración
                }
            }
            console.log('Códigos extraídos:', codigos); // Depuración
            return codigos.filter(c => c);
        }

        function verificarCodigos(codigosIngresados) {
            const registradosPorCategoria = {};
            const noRegistradosPorCategoria = {};

            codigosIngresados.forEach(codigo => {
                // Buscar el producto en el arreglo productos
                const producto = productos.find(producto => producto.codigo === codigo);
                if (producto) {
                    // Producto registrado
                    const categoria = producto.categoria || 'Sin categoría';
                    if (!registradosPorCategoria[categoria]) {
                        registradosPorCategoria[categoria] = [];
                    }
                    registradosPorCategoria[categoria].push(codigo);
                } else {
                    // Producto no registrado
                    const categoria = codigoToCategoria[codigo] || 'Sin categoría';
                    if (!noRegistradosPorCategoria[categoria]) {
                        noRegistradosPorCategoria[categoria] = [];
                    }
                    noRegistradosPorCategoria[categoria].push(codigo);
                }
            });

            return { registradosPorCategoria, noRegistradosPorCategoria };
        }

        function verificarYMostrar(codigos) {
            // Validar entrada
            if (!codigos.length) {
                document.getElementById('resultado').innerHTML = 
                    '<p class="error">Por favor, ingrese o cargue al menos un código.</p>';
                return;
            }

            // Verificar si productos está definido
            if (typeof productos === 'undefined') {
                document.getElementById('resultado').innerHTML = 
                    '<p class="error">Error: No se pudo cargar el archivo productos.js.</p>';
                return;
            }

            // Verificar códigos
            const { registradosPorCategoria, noRegistradosPorCategoria } = verificarCodigos(codigos);

            // Calcular totales
            const totalRegistrados = Object.values(registradosPorCategoria)
                .reduce((sum, codigos) => sum + codigos.length, 0);
            const totalNoRegistrados = Object.values(noRegistradosPorCategoria)
                .reduce((sum, codigos) => sum + codigos.length, 0);

            // Construir el HTML para los resultados
            let resultadoHTML = '<h3>Resultados:</h3>';

            // Registrados
            resultadoHTML += `<p><strong>Registrados (${totalRegistrados}):</strong></p>`;
            if (totalRegistrados === 0) {
                resultadoHTML += '<p class="success">Ninguno</p>';
            } else {
                resultadoHTML += `
                    <table border="0" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr><th>Categoría</th><th>Códigos</th><th>Cantidad</th></tr>`;
                for (const [categoria, codigos] of Object.keys(registradosPorCategoria).sort().map(key => [key, registradosPorCategoria[key]])) {
                    resultadoHTML += `
                        <tr>
                            <td>${categoria}</td>
                            <td><span class="success">${codigos.join(', ')}</span></td>
                            <td>${codigos.length}</td>
                        </tr>`;
                }
                resultadoHTML += '</table>';
            }

            // No registrados
            resultadoHTML += `<p><strong>No registrados (${totalNoRegistrados}):</strong></p>`;
            if (totalNoRegistrados === 0) {
                resultadoHTML += '<p class="error">Ninguno</p>';
            } else {
                resultadoHTML += `
                    <table border="0" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr><th>Categoría</th><th>Códigos</th><th>Cantidad</th></tr>`;
                for (const [categoria, codigos] of Object.keys(noRegistradosPorCategoria).sort().map(key => [key, noRegistradosPorCategoria[key]])) {
                    resultadoHTML += `
                        <tr class="highlight">
                            <td>${categoria}</td>
                            <td><span class="error">${codigos.join(', ')}</span></td>
                            <td>${codigos.length}</td>
                        </tr>`;
                }
                resultadoHTML += '</table>';
            }

            // Mostrar resultado
            document.getElementById('resultado').innerHTML = resultadoHTML;
        }
    </script>
</body>
</html>
